
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>OpenShift Platform Monitoring and Alert Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="infrastructure-cluster-logging.html" />
    
    
    <link rel="prev" href="infrastructure-infra-nodes.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Infrastructure
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="infrastructure-authentication-providers.html">
            
                <a href="infrastructure-authentication-providers.html">
            
                    
                    OpenShift Authentication Providers with AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="infrastructure-infra-nodes.html">
            
                <a href="infrastructure-infra-nodes.html">
            
                    
                    OpenShift MachineSet and Infrastructure Nodes
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.3" data-path="infrastructure-monitoring-alerts.html">
            
                <a href="infrastructure-monitoring-alerts.html">
            
                    
                    OpenShift Platform Monitoring and Alert
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="infrastructure-cluster-logging.html">
            
                <a href="infrastructure-cluster-logging.html">
            
                    
                    OpenShift Cluster Logging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="infrastructure-networking.html">
            
                <a href="infrastructure-networking.html">
            
                    
                    OpenShift Networking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="infrastructure-backup-etcd.html">
            
                <a href="infrastructure-backup-etcd.html">
            
                    
                    OpenShift state backup with etcd snapshot
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Container Applications
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="helm.html">
            
                <a href="helm.html">
            
                    
                    Application Deployment with Helm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="openshift-route.html">
            
                <a href="openshift-route.html">
            
                    
                    OpenShift Route
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="hpa.html">
            
                <a href="hpa.html">
            
                    
                    Horizontal Pod Autoscaler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="health.html">
            
                <a href="health.html">
            
                    
                    Health Check
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="openshift-service-mesh.html">
            
                <a href="openshift-service-mesh.html">
            
                    
                    OpenShift Service Mesh
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="application-metrics.html">
            
                <a href="application-metrics.html">
            
                    
                    User Workload Monitoring
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="ci-cd.html">
            
                <a href="ci-cd.html">
            
                    
                    CI/CD with Azure DevOps
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >OpenShift Platform Monitoring and Alert</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="cluster-monitoring-and-alerts">Cluster Monitoring and Alerts</h1>
<!-- TOC -->
<ul>
<li><a href="#cluster-monitoring-and-alerts">Cluster Monitoring and Alerts</a><ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#openshift-mornitering-and-alert">OpenShift Mornitering and Alert</a></li>
<li><a href="#configuring-the-monitoring-stack">Configuring the monitoring stack</a></li>
<li><a href="#managing-alerts">Managing alerts</a></li>
<li><a href="#sending-notifications-to-external-systems">Sending notifications to external systems</a></li>
<li><a href="#tesing-alerts">Tesing Alerts</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>OpenShift 4.6 on VMware 6.7 U3+ or 7.0</li>
<li>VMware Cloud Native Storage to support CNS CSI</li>
<li>OpenShift installer<ul>
<li>Node subnet with DHCP pool</li>
<li>DNS</li>
<li>NTP</li>
</ul>
</li>
</ul>
<h2 id="openshift-mornitering-and-alert">OpenShift Mornitering and Alert</h2>
<p>OpenShift Container Platform includes a pre-configured, pre-installed, and self-updating monitoring stack that provides monitoring for core platform components. OpenShift Container Platform delivers monitoring best practices out of the box. A set of alerts are included by default that immediately notify cluster administrators about issues with a cluster. Default dashboards in the OpenShift Container Platform web console include visual representations of cluster metrics to help you to quickly understand the state of your cluster.</p>
<p>The OpenShift Container Platform monitoring stack is based on the Prometheus open source project and its wider ecosystem. The monitoring stack includes the following:</p>
<ul>
<li><p>Default platform monitoring components. A set of platform monitoring components are installed in the openshift-monitoring project by default during an OpenShift Container Platform installation. This provides monitoring for core OpenShift Container Platform components including Kubernetes services. The default monitoring stack also enables remote health monitoring for clusters. These components are illustrated in the Installed by default section in the following diagram.</p>
</li>
<li><p>Components for monitoring user-defined projects. After optionally enabling monitoring for user-defined projects, additional monitoring components are installed in the openshift-user-workload-monitoring project. This provides monitoring for user-defined projects.</p>
</li>
</ul>
<p>Default monitoring targets
In addition to the components of the stack itself, the default monitoring stack monitors:</p>
<ul>
<li>CoreDNS</li>
<li>Elasticsearch (if Logging is installed)</li>
<li>etcd</li>
<li>Fluentd (if Logging is installed)</li>
<li>HAProxy</li>
<li>Image registry</li>
<li>Kubelets</li>
<li>Kubernetes apiserver</li>
<li>Kubernetes controller manager</li>
<li>Kubernetes scheduler</li>
<li>Metering (if Metering is installed)</li>
<li>OpenShift apiserver</li>
<li>OpenShift controller manager</li>
<li>Operator Lifecycle Manager (OLM)</li>
</ul>
<h2 id="configuring-the-monitoring-stack">Configuring the monitoring stack</h2>
<p>The OpenShift Container Platform 4 installation program provides only a low number of configuration options before installation. Configuring most OpenShift Container Platform framework components, including the cluster monitoring stack, happens post-installation.</p>
<p>You can configure the monitoring stack by creating and updating monitoring config maps.</p>
<p>Procedure</p>
<ol>
<li><p>Check whether the cluster-monitoring-config ConfigMap object exists:</p>
<pre><code class="lang-bash">oc -n openshift-monitoring get configmap cluster-monitoring-config
</code></pre>
</li>
<li><p>If the ConfigMap object does not exist:</p>
<p>Create and apply the following YAML manifest. In this example the file is called cluster-monitoring-config.yaml:</p>
<pre><code class="lang-yaml">cat &lt;&lt;EOF | oc apply -f -
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> v1
<span class="hljs-attr">kind:</span> ConfigMap
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> cluster-monitoring-config
<span class="hljs-attr">  namespace:</span> openshift-monitoring
<span class="hljs-attr">data:</span>
  config.yaml: <span class="hljs-string">|
</span><span class="hljs-attr">    enableUserWorkload:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">    prometheusK8s:</span> 
<span class="hljs-attr">      retention:</span> <span class="hljs-number">7</span>d
<span class="hljs-attr">      externalLabels:</span>
<span class="hljs-attr">        region:</span> sea
<span class="hljs-attr">        environment:</span> dev
<span class="hljs-attr">      volumeClaimTemplate:</span>
<span class="hljs-attr">        spec:</span>
<span class="hljs-attr">          storageClassName:</span> thin
<span class="hljs-attr">          volumeMode:</span> Filesystem
<span class="hljs-attr">          resources:</span>
<span class="hljs-attr">            requests:</span>
<span class="hljs-attr">              storage:</span> <span class="hljs-number">40</span>Gi
<span class="hljs-attr">    alertmanagerMain:</span>
<span class="hljs-attr">      volumeClaimTemplate:</span>
<span class="hljs-attr">        spec:</span>
<span class="hljs-attr">          storageClassName:</span> thin
<span class="hljs-attr">          resources:</span>
<span class="hljs-attr">            requests:</span>
<span class="hljs-attr">              storage:</span> <span class="hljs-number">5</span>Gi
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> v1
<span class="hljs-attr">kind:</span> ConfigMap
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> user-workload-monitoring-config
<span class="hljs-attr">  namespace:</span> openshift-user-workload-monitoring
<span class="hljs-attr">data:</span>
  config.yaml: <span class="hljs-string">|
</span><span class="hljs-attr">    prometheus:</span> 
<span class="hljs-attr">        retention:</span> <span class="hljs-number">12</span>h 
<span class="hljs-attr">        resources:</span>
<span class="hljs-attr">          requests:</span>
<span class="hljs-attr">            cpu:</span> <span class="hljs-number">200</span>m 
<span class="hljs-attr">            memory:</span> <span class="hljs-number">1</span>Gi
EOF
</code></pre>
</li>
</ol>
<h2 id="managing-alerts">Managing alerts</h2>
<p>In OpenShift Container Platform 4.6, the Alerting UI enables you to manage alerts, silences, and alerting rules.</p>
<ul>
<li><p>Alerting rules. Alerting rules contain a set of conditions that outline a particular state within a cluster. Alerts are triggered when those conditions are true. An alerting rule can be assigned a severity that defines how the alerts are routed.</p>
</li>
<li><p>Alerts. An alert is fired when the conditions defined in an alerting rule are true. Alerts provide a notification that a set of circumstances are apparent within an OpenShift Container Platform cluster.</p>
</li>
<li><p>Silences. A silence can be applied to an alert to prevent notifications from being sent when the conditions for an alert are true. You can mute an alert after the initial notification, while you work on resolving the underlying issue.</p>
</li>
</ul>
<p><strong>Understanding alert filters</strong></p>
<p>In the Administrator perspective, the Alerts page in the Alerting UI provides details about alerts relating to default OpenShift Container Platform and user-defined projects. The page includes a summary of severity, state, and source for each alert. The time at which an alert went into its current state is also shown.</p>
<p>You can filter by alert state, severity, and source. By default, only Platform alerts that are Firing are displayed. The following describes each alert filtering option:</p>
<ul>
<li><p>Alert State filters:</p>
<ul>
<li>Firing. The alert is firing because the alert condition is true and the optional for duration has passed. The alert will continue to fire as long as the condition remains true.</li>
<li>Pending. The alert is active but is waiting for the duration that is specified in the alerting rule before it fires.</li>
<li>Silenced. The alert is now silenced for a defined time period. Silences temporarily mute alerts based on a set of label selectors that you define. Notifications will not be sent for alerts that match all the listed values or regular expressions.</li>
</ul>
</li>
<li><p>Severity filters:</p>
<ul>
<li>Critical. The condition that triggered the alert could have a critical impact. The alert requires immediate attention when fired and is typically paged to an individual or to a critical response team.</li>
<li>Warning. The alert provides a warning notification about something that might require attention in order to prevent a problem from occurring. Warnings are typically routed to a ticketing system for non-immediate review.</li>
<li>Info. The alert is provided for informational purposes only.</li>
<li>None. The alert has no defined severity.</li>
<li>You can also create custom severity definitions for alerts relating to user-defined projects.</li>
</ul>
</li>
<li><p>Source filters:</p>
<ul>
<li>Platform. Platform-level alerts relate only to default OpenShift Container Platform projects. These projects provide core OpenShift Container Platform functionality.</li>
<li>User. User alerts relate to user-defined projects. These alerts are user-created and are customizable. User-defined workload monitoring can be enabled post-installation to provide observability into your own workloads.</li>
</ul>
</li>
</ul>
<h2 id="sending-notifications-to-external-systems">Sending notifications to external systems</h2>
<p>In OpenShift Container Platform 4.6, firing alerts can be viewed in the Alerting UI. Alerts are not configured by default to be sent to any notification systems. You can configure OpenShift Container Platform to send alerts to the following receiver types:</p>
<ul>
<li>PagerDuty</li>
<li>Webhook</li>
<li>Email</li>
<li>Slack</li>
</ul>
<p>Routing alerts to receivers enables you to send timely notifications to the appropriate teams when failures occur. For example, critical alerts require immediate attention and are typically paged to an individual or a critical response team. Alerts that provide non-critical warning notifications might instead be routed to a ticketing system for non-immediate review.</p>
<p>**Set up Test Mail Server and Slack Channel</p>
<p>Before we configure the AlertManager to send email and slack alert, we will need to run a webmail with smtp and slack channel for testing</p>
<ol>
<li><p>Deploy the maildev in default namespace and expose webmail</p>
<pre><code class="lang-bash">oc project default
oc new-app --docker-image=maildev/maildev --name=<span class="hljs-string">&apos;maildev&apos;</span>
oc expose service/maildev --port=80
</code></pre>
<p>From this deployment you can reach smtp via <code>maildev.default.svc.cluster.local:25</code> and webmail from route host using command <code>oc get route</code></p>
</li>
<li><p>Create Slack Channel webhooks token, or use prepared token you have</p>
</li>
<li><p>Webhook notification with line-notify-gateway
You will need to setup <a href="https://notify-bot.line.me/my/" target="_blank">Line Notification service</a> to allow Line Notifications in your chat group. After you setup you will get your token to use in AlertManager webhook to <code>line-notify-gateway</code> container, which is provided as an example for receive AlertManager webhook json and send to Line Notification Service.</p>
<pre><code class="lang-bash">oc -n default new-app --docker-image=nontster/line-notify-gateway
oc -n default get svc
</code></pre>
</li>
</ol>
<p><strong>Configuring alert receivers</strong></p>
<p>Procedure</p>
<ol>
<li><p>In the Administrator perspective, navigate to Administration &#x2192; Cluster Settings &#x2192; Global Configuration &#x2192; Alertmanager.</p>
</li>
<li><p>You can apply Alert Receivers configuration example that includes receivers for smtp to webmail, slack and line-notification-gateway.</p>
<pre><code class="lang-yaml"> cat &lt;&lt;EOF | oc apply -f -
<span class="hljs-attr"> kind:</span> Secret
<span class="hljs-attr"> apiVersion:</span> v1
<span class="hljs-attr"> metadata:</span>
<span class="hljs-attr">   name:</span> alertmanager-main
<span class="hljs-attr">   namespace:</span> openshift-monitoring
<span class="hljs-attr"> data:</span>
   alertmanager.yaml: &gt;-
     Z2xvYmFsOgogIHJlc29sdmVfdGltZW91dDogNW0KICBzbXRwX2Zyb206IG9jcEBleGFtcGxlLmNvbQogIHNtdHBfc21hcnRob3N0OiAnbWFpbGRldi5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsOjI1JwogIHNtdHBfaGVsbG86IGxvY2FsaG9zdAogIHNtdHBfcmVxdWlyZV90bHM6IGZhbHNlCiAgc2xhY2tfYXBpX3VybDogPi0KICAgIGh0dHBzOi8vaG9va3Muc2xhY2suY29tL3NlcnZpY2VzL1QwMUJBNVoxUUczL0IwMUpEMEZTSzVXL01kWGJpTlpxRjVVTlZ1MWtReWE2dEFlRgppbmhpYml0X3J1bGVzOgogIC0gZXF1YWw6CiAgICAgIC0gbmFtZXNwYWNlCiAgICAgIC0gYWxlcnRuYW1lCiAgICBzb3VyY2VfbWF0Y2g6CiAgICAgIHNldmVyaXR5OiBjcml0aWNhbAogICAgdGFyZ2V0X21hdGNoX3JlOgogICAgICBzZXZlcml0eTogd2FybmluZ3xpbmZvCiAgLSBlcXVhbDoKICAgICAgLSBuYW1lc3BhY2UKICAgICAgLSBhbGVydG5hbWUKICAgIHNvdXJjZV9tYXRjaDoKICAgICAgc2V2ZXJpdHk6IHdhcm5pbmcKICAgIHRhcmdldF9tYXRjaF9yZToKICAgICAgc2V2ZXJpdHk6IGluZm8KcmVjZWl2ZXJzOgogIC0gbmFtZTogQ3JpdGljYWwKICAgIGVtYWlsX2NvbmZpZ3M6CiAgICAgIC0gdG86IGFkbWluQGV4YW1wbGUuY29tCiAgLSBuYW1lOiBEZWZhdWx0CiAgICBlbWFpbF9jb25maWdzOgogICAgICAtIHRvOiBhZG1pbkBleGFtcGxlLmNvbQogIC0gbmFtZTogbGluZS13YXJuaW5nCiAgICB3ZWJob29rX2NvbmZpZ3M6CiAgICAgIC0gdXJsOiA+LQogICAgICAgICAgaHR0cDovL2xpbmUtbm90aWZ5LWdhdGV3YXkuZGVmYXVsdC5zdmMuY2x1c3Rlci5sb2NhbDoxODA4MS92MS9hbGVydG1hbmFnZXIvcGF5bG9hZD9ub3RpZnlfdG9rZW49aG1OODlpUU1qTTNubE1IVkRaNnc3Y0t1S0RVaWZwd21tdzhvNGVwMTNTQwogIC0gbmFtZTogbGluZS13YXRjaGRvZwogICAgd2ViaG9va19jb25maWdzOgogICAgICAtIHVybDogPi0KICAgICAgICAgIGh0dHA6Ly9saW5lLW5vdGlmeS1nYXRld2F5LmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWw6MTgwODEvdjEvYWxlcnRtYW5hZ2VyL3BheWxvYWQ/bm90aWZ5X3Rva2VuPWhtTjg5aVFNak0zbmxNSFZEWjZ3N2NLdUtEVWlmcHdtbXc4bzRlcDEzU0MKICAtIG5hbWU6IHNsYWNrCiAgICBzbGFja19jb25maWdzOgogICAgICAtIGNoYW5uZWw6ICcjYWxlcnQnCiAgLSBuYW1lOiBzbGFjay13YXJuaW5nCiAgICBzbGFja19jb25maWdzOgogICAgICAtIGNoYW5uZWw6ICcjYWxlcnQnCiAgLSBuYW1lOiBzbGFjay13YXRjaGRvZwogICAgc2xhY2tfY29uZmlnczoKICAgICAgLSBjaGFubmVsOiAnI2FsZXJ0JwogIC0gbmFtZTogV2FybmluZwogICAgZW1haWxfY29uZmlnczoKICAgICAgLSB0bzogd2FybmluZ0BleGFtcGxlLmNvbQogIC0gbmFtZTogV2F0Y2hkb2cKICAgIGVtYWlsX2NvbmZpZ3M6CiAgICAgIC0gdG86IHdhdGNoZG9nQGV4YW1wbGUuY29tCnJvdXRlOgogIGdyb3VwX2J5OgogICAgLSBuYW1lc3BhY2UKICBncm91cF9pbnRlcnZhbDogNW0KICBncm91cF93YWl0OiAzMHMKICByZWNlaXZlcjogRGVmYXVsdAogIHJlcGVhdF9pbnRlcnZhbDogMWgKICByb3V0ZXM6CiAgICAtIHJlY2VpdmVyOiBXYXRjaGRvZwogICAgICBtYXRjaDoKICAgICAgICBhbGVydG5hbWU6IFdhdGNoZG9nCiAgICAtIHJlY2VpdmVyOiBDcml0aWNhbAogICAgICBtYXRjaDoKICAgICAgICBzZXZlcml0eTogY3JpdGljYWwKICAgIC0gcmVjZWl2ZXI6IFdhcm5pbmcKICAgICAgbWF0Y2g6CiAgICAgICAgc2V2ZXJpdHk6IHdhcm5pbmcKICAgIC0gcmVjZWl2ZXI6IHNsYWNrCiAgICAgIG1hdGNoOgogICAgICAgIHNldmVyaXR5OiBpbmZvCiAgICAtIHJlY2VpdmVyOiBzbGFjay13YXRjaGRvZwogICAgICBtYXRjaDoKICAgICAgICBhbGVydG5hbWU6IFdhdGNoZG9nCiAgICAtIHJlY2VpdmVyOiBzbGFjay13YXJuaW5nCiAgICAgIG1hdGNoOgogICAgICAgIHNldmVyaXR5OiB3YXJuaW5nCiAgICAtIHJlY2VpdmVyOiBsaW5lLXdhcm5pbmcKICAgICAgbWF0Y2g6CiAgICAgICAgc2V2ZXJpdHk6IHdhcm5pbmcKICAgIC0gcmVjZWl2ZXI6IGxpbmUtd2F0Y2hkb2cKICAgICAgbWF0Y2g6CiAgICAgICAgYWxlcnRuYW1lOiBXYXRjaGRvZwo=
<span class="hljs-attr"> type:</span> Opaque
 EOF
</code></pre>
<p> Configuration content in plain-text</p>
<pre><code class="lang-yaml"><span class="hljs-attr"> global:</span>
<span class="hljs-attr">   resolve_timeout:</span> <span class="hljs-number">5</span>m
<span class="hljs-attr">   smtp_from:</span> ocp@example.com
<span class="hljs-attr">   smtp_smarthost:</span> <span class="hljs-string">&apos;maildev.default.svc.cluster.local:25&apos;</span>
<span class="hljs-attr">   smtp_hello:</span> localhost
<span class="hljs-attr">   smtp_require_tls:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">   slack_api_url:</span> &gt;-
<span class="hljs-attr">     https:</span>//hooks.slack.com/services/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
<span class="hljs-attr"> inhibit_rules:</span>
<span class="hljs-attr">   - equal:</span>
<span class="hljs-bullet">       -</span> namespace
<span class="hljs-bullet">       -</span> alertname
<span class="hljs-attr">     source_match:</span>
<span class="hljs-attr">       severity:</span> critical
<span class="hljs-attr">     target_match_re:</span>
<span class="hljs-attr">       severity:</span> warning|info
<span class="hljs-attr">   - equal:</span>
<span class="hljs-bullet">       -</span> namespace
<span class="hljs-bullet">       -</span> alertname
<span class="hljs-attr">     source_match:</span>
<span class="hljs-attr">       severity:</span> warning
<span class="hljs-attr">     target_match_re:</span>
<span class="hljs-attr">       severity:</span> info
<span class="hljs-attr"> receivers:</span>
<span class="hljs-attr">   - name:</span> Critical
<span class="hljs-attr">     email_configs:</span>
<span class="hljs-attr">       - to:</span> admin@example.com
<span class="hljs-attr">   - name:</span> Default
<span class="hljs-attr">     email_configs:</span>
<span class="hljs-attr">       - to:</span> admin@example.com
<span class="hljs-attr">   - name:</span> slack
<span class="hljs-attr">     slack_configs:</span>
<span class="hljs-attr">       - channel:</span> <span class="hljs-string">&apos;#alert&apos;</span>
<span class="hljs-attr">   - name:</span> slack-warning
<span class="hljs-attr">     slack_configs:</span>
<span class="hljs-attr">       - channel:</span> <span class="hljs-string">&apos;#alert&apos;</span>
<span class="hljs-attr">   - name:</span> slack-watchdog
<span class="hljs-attr">     slack_configs:</span>
<span class="hljs-attr">       - channel:</span> <span class="hljs-string">&apos;#alert&apos;</span>
<span class="hljs-attr">   - name:</span> Warning
<span class="hljs-attr">     email_configs:</span>
<span class="hljs-attr">       - to:</span> warning@example.com
<span class="hljs-attr">   - name:</span> Watchdog
<span class="hljs-attr">     email_configs:</span>
<span class="hljs-attr">       - to:</span> watchdog@example.com
<span class="hljs-attr"> route:</span>
<span class="hljs-attr">   group_by:</span>
<span class="hljs-bullet">     -</span> namespace
<span class="hljs-attr">   group_interval:</span> <span class="hljs-number">5</span>m
<span class="hljs-attr">   group_wait:</span> <span class="hljs-number">30</span>s
<span class="hljs-attr">   receiver:</span> Default
<span class="hljs-attr">   repeat_interval:</span> <span class="hljs-number">1</span>h
<span class="hljs-attr">   routes:</span>
<span class="hljs-attr">     - receiver:</span> Watchdog
<span class="hljs-attr">       match:</span>
<span class="hljs-attr">         alertname:</span> Watchdog
<span class="hljs-attr">     - receiver:</span> Critical
<span class="hljs-attr">       match:</span>
<span class="hljs-attr">         severity:</span> critical
<span class="hljs-attr">     - receiver:</span> Warning
<span class="hljs-attr">       match:</span>
<span class="hljs-attr">         severity:</span> warning
<span class="hljs-attr">     - receiver:</span> slack
<span class="hljs-attr">       match:</span>
<span class="hljs-attr">         severity:</span> info
<span class="hljs-attr">     - receiver:</span> slack-watchdog
<span class="hljs-attr">       match:</span>
<span class="hljs-attr">         alertname:</span> Watchdog
<span class="hljs-attr">     - receiver:</span> slack-warning
<span class="hljs-attr">       match:</span>
<span class="hljs-attr">         severity:</span> warning
<span class="hljs-attr">     - receiver:</span> line-warning
<span class="hljs-attr">       match:</span>
<span class="hljs-attr">         severity:</span> warning
<span class="hljs-attr">     - receiver:</span> line-watchdog
<span class="hljs-attr">       match:</span>
<span class="hljs-attr">         alertname:</span> Watchdog
</code></pre>
</li>
</ol>
<h2 id="tesing-alerts">Tesing Alerts</h2>
<p>We will demontrate Alerts from Prometheus and AlertManager by using Platform and User Workload application with metrics from cpu, memory, persistent volume resource.</p>
<p><strong>Procedures</strong></p>
<ul>
<li><p>Deploy a sample httpd pod with persistent volume 1G size mount to <code>/httpd-pvc</code> path </p>
<pre><code class="lang-yaml">oc new-project user1
cat &lt;&lt; EOF | oc create -f -
<span class="hljs-meta">---</span>
<span class="hljs-attr">kind:</span> Deployment
<span class="hljs-attr">apiVersion:</span> apps/v1
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> httpd<span class="hljs-bullet">-24</span>
<span class="hljs-attr">  namespace:</span> user1
<span class="hljs-attr">  labels:</span>
<span class="hljs-attr">    app:</span> httpd<span class="hljs-bullet">-24</span>
    app.kubernetes.io/component: httpd<span class="hljs-bullet">-24</span>
    app.kubernetes.io/instance: httpd<span class="hljs-bullet">-24</span>
    app.kubernetes.io/part-of: httpd<span class="hljs-bullet">-24</span>-app
    app.openshift.io/runtime-namespace: user1
<span class="hljs-attr">spec:</span>
<span class="hljs-attr">  replicas:</span> <span class="hljs-number">1</span>
<span class="hljs-attr">  selector:</span>
<span class="hljs-attr">    matchLabels:</span>
<span class="hljs-attr">      app:</span> httpd<span class="hljs-bullet">-24</span>
<span class="hljs-attr">  template:</span>
<span class="hljs-attr">    metadata:</span>
<span class="hljs-attr">      labels:</span>
<span class="hljs-attr">        app:</span> httpd<span class="hljs-bullet">-24</span>
<span class="hljs-attr">        deploymentconfig:</span> httpd<span class="hljs-bullet">-24</span>
<span class="hljs-attr">    spec:</span>
<span class="hljs-attr">      volumes:</span>
<span class="hljs-attr">        - name:</span> httpd-pvc
<span class="hljs-attr">          persistentVolumeClaim:</span>
<span class="hljs-attr">            claimName:</span> httpd-pvc
<span class="hljs-attr">      containers:</span>
<span class="hljs-attr">        - name:</span> httpd<span class="hljs-bullet">-24</span>
<span class="hljs-attr">          image:</span> registry.redhat.io/rhel8/httpd<span class="hljs-bullet">-24</span>
<span class="hljs-attr">          ports:</span>
<span class="hljs-attr">            - containerPort:</span> <span class="hljs-number">8080</span>
<span class="hljs-attr">              protocol:</span> TCP
<span class="hljs-attr">            - containerPort:</span> <span class="hljs-number">8443</span>
<span class="hljs-attr">              protocol:</span> TCP
<span class="hljs-attr">          volumeMounts:</span>
<span class="hljs-attr">            - name:</span> httpd-pvc
<span class="hljs-attr">              mountPath:</span> /httpd-pvc
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> v1
<span class="hljs-attr">kind:</span> PersistentVolumeClaim
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> httpd-pvc
<span class="hljs-attr">  namespace:</span> user1
<span class="hljs-attr">spec:</span>
<span class="hljs-attr">  accessModes:</span>
<span class="hljs-bullet">    -</span> ReadWriteOnce
<span class="hljs-attr">  resources:</span>
<span class="hljs-attr">    requests:</span>
<span class="hljs-attr">      storage:</span> <span class="hljs-number">1</span>Gi
<span class="hljs-attr">  storageClassName:</span> thin
<span class="hljs-attr">  volumeMode:</span> Filesystem
EOF
</code></pre>
</li>
<li><p>rsh to httpd pod to check PV size and use <code>fallocate</code> command to make PV high utilization (&gt;95%)</p>
<pre><code class="lang-bash">oc rsh $(oc -n user1 get pod | grep httpd | cut <span class="hljs-_">-d</span><span class="hljs-string">&apos; &apos;</span> <span class="hljs-_">-f</span>1)
</code></pre>
<p>check volume utilization</p>
<pre><code class="lang-bash">df -h
</code></pre>
<p>result, <code>/httpd-pvc</code>, Use 1%</p>
<pre><code class="lang-bash">Filesystem                            Size  Used Avail Use% Mounted on
overlay                               120G   19G  102G  16% /
tmpfs                                  64M     0   64M   0% /dev
tmpfs                                 3.9G     0  3.9G   0% /sys/fs/cgroup
shm                                    64M     0   64M   0% /dev/shm
tmpfs                                 3.9G   47M  3.9G   2% /etc/passwd
/dev/sdd                              976M  2.6M  958M   1% /httpd-pvc
/dev/mapper/coreos-luks-root-nocrypt  120G   19G  102G  16% /etc/hosts
tmpfs                                 3.9G   28K  3.9G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs                                 3.9G     0  3.9G   0% /proc/acpi
tmpfs                                 3.9G     0  3.9G   0% /proc/scsi
tmpfs                                 3.9G     0  3.9G   0% /sys/firmware
</code></pre>
<p>use <code>fallocate</code> to create a file with 950M size</p>
<pre><code class="lang-bash"><span class="hljs-built_in">cd</span> /httpd-pvc/
fallocate <span class="hljs-_">-l</span> 950M file.tmp
</code></pre>
<p>re-check <code>/httpd-pvc</code> again, now it is Use 100%</p>
<pre><code class="lang-bash">df -h
</code></pre>
<p>result</p>
<pre><code class="lang-bash">Filesystem                            Size  Used Avail Use% Mounted on
overlay                               120G   19G  102G  16% /
tmpfs                                  64M     0   64M   0% /dev
tmpfs                                 3.9G     0  3.9G   0% /sys/fs/cgroup
shm                                    64M     0   64M   0% /dev/shm
tmpfs                                 3.9G   47M  3.9G   2% /etc/passwd
/dev/sdd                              976M  953M  7.4M 100% /httpd-pvc
/dev/mapper/coreos-luks-root-nocrypt  120G   19G  102G  16% /etc/hosts
tmpfs                                 3.9G   28K  3.9G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs                                 3.9G     0  3.9G   0% /proc/acpi
tmpfs                                 3.9G     0  3.9G   0% /proc/scsi
tmpfs                                 3.9G     0  3.9G   0% /sys/firmware
</code></pre>
</li>
<li><p>For the User Workload Monitoring, we will need to add rolebinding to enabled permission to edit/view PrometheusRule, ServiceMonitor and PodMonitor.</p>
<p>Let&apos;s add <code>monitoring-edit</code> role to user <code>ldapuser</code></p>
<pre><code class="lang-bash">oc policy add-role-to-user monitoring-edit ldapuser -n user1
</code></pre>
</li>
<li><p>Create Prometheus Rule to alert when PV utilization is &gt;80% in namespace <code>user1</code></p>
<pre><code class="lang-yaml">cat &lt;&lt; EOF | oc create -f -
<span class="hljs-attr">apiVersion:</span> monitoring.coreos.com/v1
<span class="hljs-attr">kind:</span> PrometheusRule
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> pvfull-alert
<span class="hljs-attr">  namespace:</span> user1
<span class="hljs-attr">spec:</span>
<span class="hljs-attr">  groups:</span>
<span class="hljs-attr">  - name:</span> PersistenVolumeFullAlertRule
<span class="hljs-attr">    rules:</span>
<span class="hljs-attr">    - alert:</span> PersistenVolumeFull
<span class="hljs-attr">      expr:</span> kubelet_volume_stats_available_bytes{job=<span class="hljs-string">&quot;kubelet&quot;</span>,metrics_path=<span class="hljs-string">&quot;/metrics&quot;</span>} / kubelet_volume_stats_capacity_bytes{job=<span class="hljs-string">&quot;kubelet&quot;</span>,metrics_path=<span class="hljs-string">&quot;/metrics&quot;</span>} &lt; <span class="hljs-number">0.20</span>
<span class="hljs-attr">    for:</span> <span class="hljs-number">5</span>m
<span class="hljs-attr">    labels:</span>
<span class="hljs-attr">      secerity:</span> critical
<span class="hljs-attr">    annotations:</span>
<span class="hljs-attr">      message:</span> The PersistentVolume claimed is under <span class="hljs-number">20</span> percent free.
EOF
</code></pre>
</li>
<li><p>Now we can go back to OpenShift Console Developer View, go to <code>user1</code> project &gt; Monitoring &gt; Alerts</p>
</li>
<li>We will see our user defined alert rule and alert that trigger
<img src="images/alertrules-01.png" alt=""></li>
<li>You can click on Alert and see the details
<img src="images/alertrules-02.png" alt=""></li>
<li>When alert is Firing, firing alerts will also route to external notifications defined by AlertManager
<img src="images/alertrules-03.png" alt=""></li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="infrastructure-infra-nodes.html" class="navigation navigation-prev " aria-label="Previous page: OpenShift MachineSet and Infrastructure Nodes">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="infrastructure-cluster-logging.html" class="navigation navigation-next " aria-label="Next page: OpenShift Cluster Logging">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"OpenShift Platform Monitoring and Alert","level":"1.2.3","depth":2,"next":{"title":"OpenShift Cluster Logging","level":"1.2.4","depth":2,"path":"infrastructure-cluster-logging.md","ref":"infrastructure-cluster-logging.md","articles":[]},"previous":{"title":"OpenShift MachineSet and Infrastructure Nodes","level":"1.2.2","depth":2,"path":"infrastructure-infra-nodes.md","ref":"infrastructure-infra-nodes.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"infrastructure-monitoring-alerts.md","mtime":"2021-03-30T09:49:57.523Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-03-30T09:50:34.448Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

