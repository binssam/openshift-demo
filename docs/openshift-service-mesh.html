
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>OpenShift Service Mesh Â· OpenShift Demo</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Red Hat Thailand SA">
        
        
    
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    


    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="application-metrics.html" />
    
    
    <link rel="prev" href="health.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Infrastructure
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="infrastructure-authentication-providers.html">
            
                <a href="infrastructure-authentication-providers.html">
            
                    
                    OpenShift Authentication Providers with AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="infrastructure-infra-nodes.html">
            
                <a href="infrastructure-infra-nodes.html">
            
                    
                    OpenShift MachineSet and Infrastructure Nodes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="infrastructure-monitoring-alerts.html">
            
                <a href="infrastructure-monitoring-alerts.html">
            
                    
                    OpenShift Platform Monitoring and Alert
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="infrastructure-cluster-logging.html">
            
                <a href="infrastructure-cluster-logging.html">
            
                    
                    OpenShift Cluster Logging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="infrastructure-networking.html">
            
                <a href="infrastructure-networking.html">
            
                    
                    OpenShift Networking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="infrastructure-backup-etcd.html">
            
                <a href="infrastructure-backup-etcd.html">
            
                    
                    OpenShift state backup with etcd snapshot
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="infrastructure-taint-and-toleration.html">
            
                <a href="infrastructure-taint-and-toleration.html">
            
                    
                    Pod Taint and Toleration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="custom-roles.html">
            
                <a href="custom-roles.html">
            
                    
                    Custom Roles and Service Account
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.9" data-path="custom-alert.html">
            
                <a href="custom-alert.html">
            
                    
                    Custom Alert
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.10" data-path="compliance-operator.html">
            
                <a href="compliance-operator.html">
            
                    
                    Compliance
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Multi-cluster Management with Advanced Cluster Management (RHACM)
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="acm-application-management.html">
            
                <a href="acm-application-management.html">
            
                    
                    Application Manageement
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="acm-hibernate.html">
            
                <a href="acm-hibernate.html">
            
                    
                    Cost saving with hibernating OpenShift
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Applications
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="build-with-oc.html">
            
                <a href="build-with-oc.html">
            
                    
                    Application Build & Deployment with oc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="build-with-odo.html">
            
                <a href="build-with-odo.html">
            
                    
                    Application Build & Deployment with odo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="helm.html">
            
                <a href="helm.html">
            
                    
                    Application Deployment with Helm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="imagestreams.html">
            
                <a href="imagestreams.html">
            
                    
                    Image Streams
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="openshift-route.html">
            
                <a href="openshift-route.html">
            
                    
                    OpenShift Route
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="hpa.html">
            
                <a href="hpa.html">
            
                    
                    Horizontal Pod Autoscaler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="health.html">
            
                <a href="health.html">
            
                    
                    Health Check
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4.8" data-path="openshift-service-mesh.html">
            
                <a href="openshift-service-mesh.html">
            
                    
                    OpenShift Service Mesh
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="application-metrics.html">
            
                <a href="application-metrics.html">
            
                    
                    User Workload Monitoring
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="ci-cd-with-jenkins.html">
            
                <a href="ci-cd-with-jenkins.html">
            
                    
                    CI/CD with Jenkins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.11" data-path="ci-cd.html">
            
                <a href="ci-cd.html">
            
                    
                    CI/CD with Azure DevOps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.12" data-path="eap-on-ocp.html">
            
                <a href="eap-on-ocp.html">
            
                    
                    EAP on OpenShift
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.13" data-path="gitops.html">
            
                <a href="gitops.html">
            
                    
                    OpenShift GitOps
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >OpenShift Service Mesh</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="openshift-service-mesh">OpenShift Service Mesh</h1>
<!-- TOC -->
<ul>
<li><a href="#openshift-service-mesh">OpenShift Service Mesh</a><ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#setup-control-plane-and-sidecar">Setup Control Plane and sidecar</a></li>
<li><a href="#create-istio-gateway">Create Istio Gateway</a></li>
<li><a href="#weight-routing-with-istio-virtual-service">Weight-Routing with Istio Virtual Service</a></li>
<li><a href="#routing-by-condition-based-on-uri">Routing by condition based on URI</a></li>
<li><a href="#ab-with-istio-virtual-service">A/B with Istio Virtual Service</a></li>
<li><a href="#traffic-analysis">Traffic Analysis</a></li>
<li><a href="#distributed-tracing">Distributed Tracing</a></li>
<li><a href="#traffic-mirroring-dark-launch">Traffic Mirroring (Dark Launch)</a></li>
<li><a href="#envoy-access-log">Envoy Access Log</a></li>
<li><a href="#circuit-breaker">Circuit Breaker</a></li>
<li><a href="#secure-with-mtls">Secure with mTLS</a></li>
<li><a href="#service-level-objective-slo">Service Level Objective (SLO)</a></li>
<li><a href="#control-plane-with-high-availability">Control Plane with High Availability</a><ul>
<li><a href="#openshift-service-mesh-1x">OpenShift Service Mesh 1.x</a></li>
<li><a href="#openshift-service-mesh-2x">OpenShift Service Mesh 2.x</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h2 id="overview">Overview</h2>
<p>Sample application</p>
<p><img src="images/service-mesh-sample-app.png" alt=""></p>
<h2 id="setup-control-plane-and-sidecar">Setup Control Plane and sidecar</h2>
<ul>
<li>Install following Operators from OperatorHub<ul>
<li>ElasticSearch</li>
<li>Jaeger</li>
<li>Kiali</li>
<li>OpenShift Service Mesh</li>
</ul>
</li>
<li><p>Create control plane by create ServiceMeshControlPlane CRD</p>
<pre><code class="lang-bash">oc new-project istio-system
oc create -f manifests/smcp.yaml -n istio-system
</code></pre>
</li>
<li><p>Check for control plane(<a href="bin/get-smcp-status.sh">get-smcp-status.sh</a>)</p>
<pre><code class="lang-bash">bin/get-smcp-status.sh istio-system
</code></pre>
</li>
<li><p>Join project1 into control plane</p>
<ul>
<li><p>Review <a href="manifests/smcp.yaml">ServiceMeshMemberRoll CRD</a></p>
<pre><code class="lang-yaml">apiVersion: maistra.io/v1
kind: ServiceMeshMemberRoll
metadata:
  name: default
spec:
  members:
  - project1
</code></pre>
</li>
<li><p>Create data plane project</p>
<pre><code class="lang-bash">oc new-project project1
</code></pre>
</li>
<li><p>Apply ServiceMeshMemberRoll</p>
<pre><code class="lang-bash">oc create -f manifests/smmr.yaml -n istio-system
</code></pre>
</li>
<li><p>Check for ServiceMeshMemberRoll status</p>
<pre><code class="lang-bash">oc describe smmr/default -n istio-system | grep -A2 Spec:
</code></pre>
</li>
</ul>
</li>
<li><p>Deploy sidecar to frontend app in project1</p>
<pre><code class="lang-bash">oc apply -f manifests/frontend.yaml -n project1
oc patch deployment/frontend-v1 -p &apos;{&quot;spec&quot;:{&quot;template&quot;:{&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;sidecar.istio.io/inject&quot;:&quot;true&quot;}}}}}&apos; -n project1
oc patch deployment/frontend-v2 -p &apos;{&quot;spec&quot;:{&quot;template&quot;:{&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;sidecar.istio.io/inject&quot;:&quot;true&quot;}}}}}&apos; -n project1
</code></pre>
<p><img src="images/dev-console-frontend.png" alt=""></p>
</li>
</ul>
<ul>
<li><p>Check for sidecar in frontend-v1 and frontend-v2 pods</p>
<pre><code class="lang-bash">oc get pods -n project1
</code></pre>
<p>Sample output</p>
<pre><code class="lang-bash">NAME                           READY   STATUS        RESTARTS   AGE
frontend-v1-577b98f48c-6j5zg   2/2     Running       0          15s
frontend-v1-c5d4648f9-7jfk2    1/1     Terminating   0          13m
frontend-v2-5cd968bc59-cwsd8   2/2     Running       0          14s
frontend-v2-5d4dbdbc9-k6787    1/1     Terminating   0          13m
</code></pre>
<p>Check developer console</p>
<p><img src="images/pod-with-sidecar.png" alt=""></p>
</li>
</ul>
<ul>
<li><p>Check <a href="manifests/frontend-service.yaml">frontend service</a> which set slector to both v1 and v2</p>
<pre><code class="lang-yaml">selector:
  app: frontend
</code></pre>
</li>
<li><p>Create <a href="manifests/frontend-service.yaml">frontend service</a></p>
<pre><code class="lang-bash">oc create -f manifests/frontend-service.yaml -n project1
</code></pre>
</li>
</ul>
<h2 id="create-istio-gateway">Create Istio Gateway</h2>
<ul>
<li><p>Create Gateway for frontend app</p>
<ul>
<li>Check for cluster&apos;s sub-domain<pre><code class="lang-bash">SUBDOMAIN=$(oc whoami --show-console|awk -F&apos;apps.&apos; &apos;{print $2}&apos;)
echo $SUBDOMAIN
</code></pre>
</li>
<li><p>Review <a href="manifests/frontend-gateway.yaml">Gateway CRD</a>, Replaced SUBDOMAIN with cluster&apos;s sub-domain</p>
<pre><code class="lang-yaml">apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
name: frontend-gateway
spec:
selector:
    istio: ingressgateway # use istio default controller
servers:
- port:
    number: 80
    name: http2
    protocol: HTTP
    hosts:
    - &apos;frontend.apps.SUBDOMAIN&apos;
</code></pre>
</li>
<li><p>Replace SUBDOMAIN with your clsuter sub-domain and Create <a href="manifests/frontend-gateway.yaml">gateway</a></p>
<pre><code class="lang-bash">oc apply -f manifests/frontend-gateway.yaml -n istio-system
</code></pre>
<p>or use following bash command </p>
<pre><code class="lang-bash">SUBDOMAIN=$(oc whoami --show-console|awk -F&apos;apps.&apos; &apos;{print $2}&apos;)
cat manifests/frontend-gateway.yaml | sed &apos;s/SUBDOMAIN/&apos;$SUBDOMAIN&apos;/&apos;|oc apply -n istio-system -f -
</code></pre>
</li>
</ul>
</li>
<li><p>Create Destination Rule for frontend v1 and frontend v2</p>
<ul>
<li><p>Review <a href="manifests/frontend-destination-rule.yaml">Destination Rule CRD</a></p>
<pre><code class="lang-yaml">apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
    name: frontend
spec:
    host: frontend
    subsets:
    - name: v1
    labels:
        app: frontend
        version: v1
    trafficPolicy:
        loadBalancer:
        simple: ROUND_ROBIN
    - name: v2
    labels:
        app: frontend
        version: v2
    trafficPolicy:
        loadBalancer:
        simple: ROUND_ROBIN
</code></pre>
</li>
<li><p>Create destination rule</p>
<pre><code class="lang-bash">oc apply -f manifests/frontend-destination-rule.yaml -n project1
</code></pre>
</li>
</ul>
</li>
<li><p>Create Virtual Service for frontend app</p>
<ul>
<li><p>Review <a href="manifests/frontend-virtual-service.yaml">Virtual Service CRD</a>, Replace SUBDOMAIN with cluster&apos;s sub-domain.</p>
<pre><code class="lang-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
    name: frontend
spec:
    hosts:
    - frontend.apps.SUBDOMAIN
    gateways:
    - istio-system/frontend-gateway
    http:
    - route:
    - destination:
        port:
            number: 8080
        host: frontend.project1.svc.cluster.local
</code></pre>
</li>
<li><p>Replace SUBDOMAIN with cluster subdomain and create <a href="manifests/frontend-virtual-service.yaml">virtual service</a></p>
<pre><code class="lang-bash">oc apply -f manifests/frontend-virtual-service.yaml -n project1
</code></pre>
<p>or use following bash command </p>
<pre><code class="lang-bash">SUBDOMAIN=$(oc whoami --show-console|awk -F&apos;apps.&apos; &apos;{print $2}&apos;)
cat manifests/frontend-virtual-service.yaml | sed &apos;s/SUBDOMAIN/&apos;$SUBDOMAIN&apos;/&apos;|oc apply -n project1 -f -
</code></pre>
</li>
<li><p>Check that route is automatically created</p>
<pre><code class="lang-bash">oc get route -n istio-system | grep istio-system-frontend-gateway
</code></pre>
<p>Sample outout</p>
<pre><code class="lang-bash">istio-system-frontend-gateway-fmlsp   frontend.apps.cluster-ba08.ba08.example.opentlc.com                                   istio-ingressgateway   http2                                  istio-ingressgateway   http2                        None
</code></pre>
<p>&lt;!-- - Create Route (configured with Istio Gateway) for frontend app</p>
</li>
<li><p>Review <a href="manifests/frontend-route-istio.yaml">Route</a>, Replace SUBDOMAIN with cluster&apos;s subdomain</p>
<pre><code class="lang-yaml">apiVersion: v1
kind: Route
metadata:
    name: frontend
spec:
    host: frontend.apps.SUBDOMAIN
    port:
    targetPort: http2
    to:
    kind: Service
    name: istio-ingressgateway
    weight: 100
    wildcardPolicy: None
</code></pre>
</li>
<li><p>Replace SUBDOMAIN with cluster subdomain then create Route</p>
<pre><code class="lang-bash">oc apply -f manifests/frontend-route-istio.yaml -n istio-system
</code></pre>
<p>or use following bash command </p>
<p><code>bash
SUBDOMAIN=$(oc whoami --show-console|awk -F&apos;apps.&apos; &apos;{print $2}&apos;)
cat manifests/frontend-route-istio.yaml | sed &apos;s/SUBDOMAIN/&apos;$SUBDOMAIN&apos;/&apos;|oc apply -n project1 -f -</code> --&gt;</p>
</li>
</ul>
</li>
<li><p>Test with cURL</p>
</li>
</ul>
<pre><code class="lang-bash">FRONTEND_ISTIO_ROUTE=$(oc get route -n istio-system|grep istio-system-frontend-gateway |awk &apos;{print $2}&apos;)
curl http://$FRONTEND_ISTIO_ROUTE
</code></pre>
<h2 id="weight-routing-with-istio-virtual-service">Weight-Routing with Istio Virtual Service</h2>
<ul>
<li><p>Set weight routing between 2 services with virtual service</p>
<ul>
<li>Check for <a href="manifests/frontend-virtual-service-with-weight-routing.yaml">virtual service with weight routing</a>, Replace SUBDOMAIN with cluster&apos;s subdomain.<pre><code class="lang-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
name: frontend
spec:
hosts:
- frontend.apps.SUBDOMAIN
gateways:
- istio-system/frontend-gateway
http:
- route:
  - destination:
      port:
        number: 8080
      host: frontend.project1.svc.cluster.local
      subset: v1
    weight: 100
  - destination:
      port:
        number: 8080
      host: frontend.project1.svc.cluster.local
      subset: v2
    weight: 0
</code></pre>
or use following bash command </li>
</ul>
<pre><code class="lang-bash">SUBDOMAIN=$(oc whoami --show-console|awk -F&apos;apps.&apos; &apos;{print $2}&apos;)
cat manifests/frontend-virtual-service-with-weight-routing.yaml | sed &apos;s/SUBDOMAIN/&apos;$SUBDOMAIN&apos;/&apos;|oc apply -n project1 -f -
</code></pre>
<ul>
<li><p>Apply <a href="manifests/frontend-virtual-service-with-weight-routing.yaml">virtual service</a> for Blue/Green deployment with route all traffic to v1</p>
<pre><code class="lang-bash">oc apply -f manifests/frontend-virtual-service-with-weight-routing.yaml -n project1
</code></pre>
</li>
</ul>
<ul>
<li>Test with cURL to verify that all requests are routed to v1</li>
<li><p>Blue/Green deployment by route all requests to v2</p>
<pre><code class="lang-bash">oc patch virtualservice frontend --type=&apos;json&apos; -p=&apos;[{&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;/spec/http/0&quot;,&quot;value&quot;:{&quot;route&quot;:[{&quot;destination&quot;:{&quot;host&quot;:&quot;frontend.project1.svc.cluster.local&quot;,&quot;port&quot;:{&quot;number&quot;:8080},&quot;subset&quot;:&quot;v1&quot;},&quot;weight&quot;:0},{&quot;destination&quot;:{&quot;host&quot;:&quot;frontend.project1.svc.cluster.local&quot;,&quot;port&quot;:{&quot;number&quot;:8080},&quot;subset&quot;:&quot;v2&quot;},&quot;weight&quot;:100}]}}]&apos; -n project1
</code></pre>
</li>
<li><p>Test with cURL to verify that all requests are routed to v2</p>
</li>
<li><p>Canary deployment by weight requests between v1 and v2 with 70% and 30%</p>
<pre><code class="lang-bash">oc patch virtualservice frontend --type=&apos;json&apos; -p=&apos;[{&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;/spec/http/0&quot;,&quot;value&quot;:{&quot;route&quot;:[{&quot;destination&quot;:{&quot;host&quot;:&quot;frontend.project1.svc.cluster.local&quot;,&quot;port&quot;:{&quot;number&quot;:8080},&quot;subset&quot;:&quot;v1&quot;},&quot;weight&quot;:70},{&quot;destination&quot;:{&quot;host&quot;:&quot;frontend.project1.svc.cluster.local&quot;,&quot;port&quot;:{&quot;number&quot;:8080},&quot;subset&quot;:&quot;v2&quot;},&quot;weight&quot;:30}]}}]&apos; -n project1
</code></pre>
</li>
</ul>
</li>
<li><p>Test canary deployment</p>
<ul>
<li><p>Run 100 requests</p>
<pre><code class="lang-bash">FRONTEND_ISTIO_ROUTE=$(oc get route -n istio-system|grep istio-system-frontend-gateway |awk &apos;{print $2}&apos;)
COUNT=0
rm -f result.txt
while [ $COUNT -lt 100 ];
do
    OUTPUT=$(curl -s $FRONTEND_ISTIO_ROUTE/version)
    printf &quot;%s\n&quot; $OUTPUT &gt;&gt; result.txt
    printf &quot;%s\n&quot; $OUTPUT
    sleep .2
    COUNT=$(expr $COUNT + 1)
done
</code></pre>
</li>
<li><p>Check result for comparing percentage of requests to v1 and v2</p>
<pre><code class="lang-bash">printf &quot;Version 1: %s\n&quot; $(cat result.txt | grep &quot;1.0.0&quot; | wc -l)
printf &quot;Version 2: %s\n&quot; $(cat result.txt | grep &quot;2.0.0&quot; | wc -l)
rm -f result.txt
</code></pre>
</li>
</ul>
</li>
</ul>
<h2 id="routing-by-condition-based-on-uri">Routing by condition based on URI</h2>
<ul>
<li>Set conditional routing between 2 services with virtual service<ul>
<li>Check for <a href="manifests/frontend-virtual-service-with-uri.yaml">virtual service by URI</a>, Replace SUBDOMAIN with cluster&apos;s subdomain. Condition with regular expression<ul>
<li>Route to v1 if request URI start with &quot;/ver&quot; and end with &quot;1&quot;<pre><code class="lang-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
name: frontend
spec:
hosts:
- frontend.apps.SUBDOMAIN
gateways:
- istio-system/frontend-gateway
http:
- match:
- uri:
    regex: /ver(.*)1
rewrite:
# Rewrite URI back to / because frontend app not have /ver(*)1
uri: &quot;/&quot;
route:
- destination:
    host: frontend
    port:
    number: 8080
    subset: v1
- route:
- destination:
    host: frontend
    port:
    number: 8080
    subset: v2
</code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Apply virtual service</p>
<pre><code class="lang-bash">oc apply -f manifests/frontend-virtual-service-with-uri.yaml -n project1
</code></pre>
<p>or use following bash command </p>
<pre><code class="lang-bash">SUBDOMAIN=$(oc whoami --show-console|awk -F&apos;apps.&apos; &apos;{print $2}&apos;)
cat manifests/frontend-virtual-service-with-uri.yaml | sed &apos;s/SUBDOMAIN/&apos;$SUBDOMAIN&apos;/&apos;|oc apply -n project1 -f -
</code></pre>
</li>
<li><p>Test with URI /version1 and /ver1</p>
<pre><code class="lang-bash">FRONTEND_ISTIO_ROUTE=$(oc get route -n istio-system|grep istio-system-frontend-gateway |awk &apos;{print $2}&apos;)
curl $FRONTEND_ISTIO_ROUTE/version1
curl $FRONTEND_ISTIO_ROUTE/vers1
curl $FRONTEND_ISTIO_ROUTE/ver1
</code></pre>
</li>
<li><p>Test with URI /</p>
<pre><code class="lang-bash">FRONTEND_ISTIO_ROUTE=$(oc get route -n istio-system|grep istio-system-frontend-gateway |awk &apos;{print $2}&apos;)
curl $FRONTEND_ISTIO_ROUTE/
</code></pre>
</li>
</ul>
<h2 id="ab-with-istio-virtual-service">A/B with Istio Virtual Service</h2>
<ul>
<li><p>A/B testing by investigating User-Agent header with <a href="manifests/frontend-virtual-service-with-header.yaml">Virtual Service</a>, Replace SUBDOMAIN with cluster&apos;s sub-domain.</p>
<ul>
<li>If HTTP header User-Agent contains text Firewall, request will be routed to frontend v2</li>
</ul>
<pre><code class="lang-yaml">apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: frontend
spec:
  hosts:
  - frontend.apps.SUBDOMAIN
  gateways:
  - istio-gateway/frontend-gateway
  http:
  - match:
    - headers:
        user-agent:
          regex: (.*)Firefox(.*)
    route:
    - destination:
        host: frontend
        port:
          number: 8080
        subset: v2
  - route:
    - destination:
        host: frontend
        port:
          number: 8080
        subset: v1
</code></pre>
</li>
<li><p>Apply <a href="manifests/frontend-virtual-service-with-header.yaml">Virtual Service</a></p>
<pre><code class="lang-bash">oc apply -f manifests/frontend-virtual-service-with-header.yaml -n project1
</code></pre>
<p>or use following bash command </p>
<pre><code class="lang-bash">SUBDOMAIN=$(oc whoami --show-console|awk -F&apos;apps.&apos; &apos;{print $2}&apos;)
cat manifests/frontend-virtual-service-with-header.yaml | sed &apos;s/SUBDOMAIN/&apos;$SUBDOMAIN&apos;/&apos;|oc apply -n project1 -f -
</code></pre>
</li>
<li><p>Test with cURL with HTTP header User-Agent contains Firefox</p>
<pre><code class="lang-bash">FRONTEND_ISTIO_ROUTE=$(oc get route -n istio-system|grep istio-system-frontend-gateway |awk &apos;{print $2}&apos;)
curl -H &quot;User-Agent:Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:78.0) Gecko/20100101 Firefox/78.0&quot; $FRONTEND_ISTIO_ROUTE
</code></pre>
<h2 id="traffic-analysis">Traffic Analysis</h2>
</li>
<li><p>Deploy backend application</p>
<pre><code class="lang-bash">oc apply -f manifests/backend.yaml -n project1
oc apply -f manifests/backend-destination-rule.yaml -n project1
oc apply -f manifests/backend-virtual-service-v1-v2-50-50.yaml -n project1
oc get pods -n project1
</code></pre>
</li>
<li><p><strong>Optional</strong>: Draw connetion from frontend to backend in Developer Console</p>
<pre><code class="lang-bash">oc annotate deployment frontend-v1 &apos;app.openshift.io/connects-to=[{&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;name&quot;:&quot;backend-v1&quot;},{&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;name&quot;:&quot;backend-v2&quot;}]&apos; -n project1
oc annotate deployment frontend-v2 &apos;app.openshift.io/connects-to=[{&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;name&quot;:&quot;backend-v1&quot;},{&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;name&quot;:&quot;backend-v2&quot;}]&apos; -n project1
</code></pre>
<p><img src="images/dev-console-topology-frontend-v1-v2-backend-v1-v2.png" alt=""></p>
</li>
<li><p>Configure frontend to request to backend</p>
<pre><code class="lang-bash">oc set env deployment/frontend-v1 BACKEND_URL=http://backend:8080/ -n project1
oc set env deployment/frontend-v2 BACKEND_URL=http://backend:8080/ -n project1
</code></pre>
</li>
<li><p>Check Kiali Console</p>
</li>
<li><p>login to OpenShift Developer Console, select project istio-system and open Kiali console </p>
<p><img src="images/istio-system-project.png" alt=""></p>
</li>
<li>Login to Kiali Console and select Graph<ul>
<li>Namespace: select checkbox &quot;project1&quot;</li>
<li>Display: select checkbox &quot;Requests percentage&quot; and &quot;Traffic animation&quot;</li>
</ul>
</li>
<li>Run following command<pre><code class="lang-bash">oc patch virtualservice frontend --type=&apos;json&apos; -p=&apos;[{&quot;op&quot;:&quot;replace&quot;,&quot;path&quot;:&quot;/spec/http/0&quot;,&quot;value&quot;:{&quot;route&quot;:[{&quot;destination&quot;:{&quot;host&quot;:&quot;frontend.project1.svc.cluster.local&quot;,&quot;port&quot;:{&quot;number&quot;:8080},&quot;subset&quot;:&quot;v1&quot;},&quot;weight&quot;:70},{&quot;destination&quot;:{&quot;host&quot;:&quot;frontend.project1.svc.cluster.local&quot;,&quot;port&quot;:{&quot;number&quot;:8080},&quot;subset&quot;:&quot;v2&quot;},&quot;weight&quot;:30}]}}]&apos; -n project1
FRONTEND_ISTIO_ROUTE=$(oc get route -n istio-system|grep istio-system-frontend-gateway |awk &apos;{print $2}&apos;)
while [ 1 ];
do
        OUTPUT=$(curl -s $FRONTEND_ISTIO_ROUTE)
        printf &quot;%s\n&quot; $OUTPUT
        sleep .2
done
</code></pre>
</li>
<li><p>Check Kiali Console</p>
<p><img src="images/kiali-graph.png" alt=""></p>
</li>
<li><p>Traffic analysis for frontend app. Select Application-&gt;frontend-&gt;inbound traffic and outbound traffic</p>
<p><img src="images/kiali-frontend-inboud-traffic.png" alt=""></p>
</li>
</ul>
<h2 id="distributed-tracing">Distributed Tracing</h2>
<ul>
<li><p>Distributed tracing with Jaeger. Select tab Tracing</p>
<ul>
<li><p>Overall tracing for frontend app</p>
<p><img src="images/frontend-app-tracing.png" alt=""></p>
</li>
<li><p>Login to Jaeger by select &quot;View in Tracing&quot;</p>
<p><img src="images/jaeger-main.png" alt=""></p>
</li>
<li><p>Drill down to tracing information</p>
<p><img src="images/jaeger-transaction.png" alt=""> </p>
</li>
<li><p>Show feature config on the fly in service --&gt; frontend v2 --&gt; action</p>
</li>
</ul>
</li>
</ul>
<h2 id="traffic-mirroring-dark-launch">Traffic Mirroring (Dark Launch)</h2>
<ul>
<li><p>Deploy audit app and mirror every requests that frontend call backend to audit app</p>
<pre><code class="lang-bash">oc apply -f manifests/audit-app.yaml -n project1
oc get pods -n project1
</code></pre>
</li>
<li><p>Update <a href="manifests/backend-virtual-service-mirror.yaml">backend virtual service</a> to mirror requests to audit app.</p>
<pre><code class="lang-bash">oc apply -f manifests/backend-virtual-service-mirror.yaml -n project1
</code></pre>
</li>
<li><p>Use cURL to call frontend and check audit&apos;s pod log by CLI (with another terminal) or Web Console</p>
<ul>
<li>cURL frontend</li>
</ul>
<pre><code class="lang-bash">FRONTEND_ISTIO_ROUTE=$(oc get route -n istio-system|grep istio-system-frontend-gateway |awk &apos;{print $2}&apos;)
curl $FRONTEND_ISTIO_ROUTE
</code></pre>
<ul>
<li>View audit log </li>
</ul>
<pre><code class="lang-bash">oc logs -f $(oc get pods --no-headers | grep audit|head -n 1|awk &apos;{print $1}&apos;) -c backend -n project1
</code></pre>
<p><img src="images/mirror-log.png" alt=""></p>
</li>
</ul>
<h2 id="envoy-access-log">Envoy Access Log</h2>
<ul>
<li>Envoy access log already enabled with <a href="manifests/smcp.yaml">ServiceMeshControlPlane CRD</a><pre><code class="lang-yaml">  proxy:
  accessLogging:
    envoyService:
      enabled: false
    file:
      encoding: TEXT
      name: /dev/stdout
</code></pre>
</li>
<li><p>Check access log</p>
<pre><code class="lang-bash">oc logs -f $(oc get pods -n project1 --no-headers|grep frontend|head -n 1|awk &apos;{print $1}&apos;) -c istio-proxy -n project1
</code></pre>
<p>Sample output</p>
<pre><code class="lang-log">[2020-12-25T10:33:04.848Z] &quot;GET / HTTP/1.1&quot; 200 - &quot;-&quot; &quot;-&quot; 0 103 5750 5749 &quot;-&quot; &quot;-&quot; &quot;0c3ce34a-f5a0-9340-b84f-3631cd8eb444&quot; &quot;backend:8080&quot; &quot;10.128.2.133:8080&quot; outbound|8080|v2|backend.project1.svc.cluster.local 10.128.2.131:48300 172.30.116.252:8080 10.128.2.131:36992 - -
[2020-12-25T10:33:04.846Z] &quot;GET / HTTP/1.1&quot; 200 - &quot;-&quot; &quot;-&quot; 0 184 5756 5755 &quot;184.22.250.124,10.131.0.4&quot; &quot;curl/7.64.1&quot; &quot;0c3ce34a-f5a0-9340-b84f-3631cd8eb444&quot; &quot;frontend.apps.cluster-1138.1138.example.opentlc.com&quot; &quot;127.0.0.1:8080&quot; inbound|8080|http|frontend-v1.project1.svc.cluster.local 127.0.0.1:56540 10.128.2.131:8080 10.131.0.4:0 outbound_.8080_.v1_.frontend.project1.svc.cluster.local default
</code></pre>
</li>
</ul>
<h2 id="circuit-breaker">Circuit Breaker</h2>
<ul>
<li><p>Configure our application to contains only frontend-v1 and backend-v1 and scale backend to 3 pods.</p>
<pre><code class="lang-bash">oc apply -f manifests/frontend.yaml -n project1
oc patch deployment/frontend-v1 -p &apos;{&quot;spec&quot;:{&quot;template&quot;:{&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;sidecar.istio.io/inject&quot;:&quot;true&quot;}}}}}&apos; -n project1
oc apply -f manifests/backend.yaml -n project1
oc delete deployment frontend-v2 -n project1
oc delete deployment backend-v2 -n project1 
oc delete svc frontend-v2 -n project1
oc set env deployment/frontend-v1 BACKEND_URL=http://backend:8080/ -n project1
oc annotate deployment frontend-v1 &apos;app.openshift.io/connects-to=[{&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;name&quot;:&quot;backend-v1&quot;},{&quot;apiVersion&quot;:&quot;apps/v1&quot;,&quot;kind&quot;:&quot;Deployment&quot;,&quot;name&quot;:&quot;backend-v2&quot;}]&apos; -n project1
oc delete route frontend -n project1
oc scale deployment backend-v1 --replicas=3 -n project1
oc apply -f manifests/backend-destination-rule-v1-only.yaml -n project1
oc apply -f manifests/backend-virtual-service.yaml -n project1
oc apply -f manifests/frontend-destination-rule-v1-only.yaml -n project1
SUBDOMAIN=$(oc whoami --show-console|awk -F&apos;apps.&apos; &apos;{print $2}&apos;)
cat manifests/frontend-virtual-service.yaml | sed &apos;s/SUBDOMAIN/&apos;$SUBDOMAIN&apos;/&apos;|oc apply -n project1 -f -
SUBDOMAIN=$(oc whoami --show-console|awk -F&apos;apps.&apos; &apos;{print $2}&apos;)
cat manifests/frontend-gateway.yaml | sed &apos;s/SUBDOMAIN/&apos;$SUBDOMAIN&apos;/&apos;|oc apply -n istio-system -f -
oc get pods -n project1
</code></pre>
</li>
<li><p>Test with cURL</p>
<pre><code class="lang-bash">FRONTEND_ISTIO_ROUTE=$(oc get route -n istio-system|grep istio-system-frontend-gateway |awk &apos;{print $2}&apos;)
curl http://$FRONTEND_ISTIO_ROUTE
</code></pre>
<p>Sample output - Check for field Host that is backend pod that processed for this request</p>
<pre><code class="lang-bash">Frontend version: 1.0.0 =&gt; [Backend: http://backend:8080/, Response: 200, Body: Backend version:v1, Response:200, Host:backend-v1-f4dbf777f-h7rwg, Status:200, Message: Hello, Quarkus]
</code></pre>
</li>
<li><p>Loop 6 times. Result from backend will be round robin.</p>
<ul>
<li>Create bash function</li>
</ul>
<pre><code class="lang-bash">function loop_frontend(){
  FRONTEND_ISTIO_ROUTE=$(oc get route -n istio-system|grep istio-system-frontend-gateway |awk &apos;{print $2}&apos;)
  COUNT=0
  MAX=$1
  while [ $COUNT -lt $MAX ];
  do
    curl -s http://$FRONTEND_ISTIO_ROUTE | awk -F&apos;,&apos; &apos;{print $5 &quot;=&gt;&quot; $6}&apos;
    COUNT=$(expr $COUNT + 1 )
  done
}
</code></pre>
<ul>
<li>Run function with input paramter 6</li>
</ul>
<pre><code class="lang-bash">loop_frontend 6
</code></pre>
<p>Sample output</p>
<pre><code class="lang-bash">Host:backend-v1-f4dbf777f-vjhcl=&gt; Status:200
Host:backend-v1-f4dbf777f-vjhcl=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-h7rwg=&gt; Status:200
Host:backend-v1-f4dbf777f-vjhcl=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
</code></pre>
</li>
<li><p>By default, Envoy will automatically retry if it get response with code 503</p>
<ul>
<li><p>Force one backend pod to return 503 </p>
<ul>
<li><p>by command line.</p>
<pre><code class="lang-bash">oc exec -n project1 -c backend $(oc get pod -n project1 | grep -m1 backend | cut -d &quot; &quot; -f1) -- curl -s http://localhost:8080/not_ready
</code></pre>
</li>
</ul>
<p>Sample output</p>
<pre><code class="lang-bash">Backend version:v1, Response:200, Host:backend-v1-f4dbf777f-h7rwg, Status:200, Message: Readiness: false
</code></pre>
<ul>
<li><p>by Web Console</p>
<p><img src="images/dev-console-terminal-set-pod-not-ready.png" alt=""></p>
</li>
</ul>
</li>
<li><p>Verify response from that pod.</p>
<pre><code class="lang-bash">oc exec -n project1 -c backend $(oc get pod -n project1 | grep -m1 backend | cut -d &quot; &quot; -f1) -- curl -sv http://localhost:8080/
</code></pre>
<p>Sample Output</p>
<pre><code class="lang-bash">*   Trying ::1...
* TCP_NODELAY set
* Connected to localhost (::1) port 8080 (#0)
&gt; GET / HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.61.1
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 503 Service Unavailable
&lt; Content-Encoding: text/plain
&lt; Expires: Tue, 02 Feb 2021 08:18:22 GMT
&lt; Content-Length: 125
&lt; Content-Type: text/plain;charset=UTF-8
&lt;
* Connection #0 to host localhost left intact
 Backend version:v1, Response:503, Host:backend-v1-f4dbf777f-h7rwg, Status:503, Message: Application readiness is set to false
</code></pre>
</li>
<li><p>Test with cURL again. You will get only status 200</p>
<pre><code class="lang-bash">loop_frontend 10
</code></pre>
<p>Sample Output</p>
<pre><code class="lang-bash">Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
</code></pre>
</li>
<li><p>Set backend pod to return 200</p>
<pre><code class="lang-bash">oc exec -n project1 -c backend $(oc get pod -n project1 | grep -m1 backend | cut -d &quot; &quot; -f1) -- curl -s http://localhost:8080/ready
</code></pre>
</li>
</ul>
</li>
<li>Test CB</li>
<li><p>Update destination rule with circuit breaker</p>
<pre><code class="lang-bash">oc apply -f manifests/backend-destination-rule-circuit-breaker.yaml -n project1
</code></pre>
</li>
<li><p>Review Circuit Breaker configuration in <a href="manifests/backend-destination-rule-circuit-breaker.yaml">deatination rule</a></p>
<ul>
<li>If found error 1 times (consecutiveErrors)</li>
<li>then eject that pod from pool for 15 mintues (baseEjectionTime)</li>
<li>Maximum number of pod that can be ejected is 100% (maxEjectionPercent)</li>
<li>Check this every 15 min (interval)</li>
</ul>
<pre><code class="lang-yaml">outlierDetection:
      baseEjectionTime: 15m
      consecutiveErrors: 1
      interval: 15m
      maxEjectionPercent: 100
</code></pre>
</li>
<li><p>Set one backend pod to return 504 and verify that pod return 504</p>
<pre><code class="lang-bash">oc exec -n project1 -c backend $(oc get pod -n project1 | grep -m1 backend | cut -d &quot; &quot; -f1) -- curl -sv http://localhost:8080/stop
</code></pre>
<p>Sample output</p>
<pre><code>*   Trying ::1...
* TCP_NODELAY set
* Connected to localhost (::1) port 8080 (#0)
&gt; GET /stop HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.61.1
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Content-Encoding: text/plain
&lt; Expires: Tue, 02 Feb 2021 08:37:59 GMT
&lt; Content-Length: 103
&lt; Content-Type: text/plain;charset=UTF-8
&lt;
{ [103 bytes data]
* Connection #0 to host localhost left intact
Backend version:v1, Response:200, Host:backend-v1-f4dbf777f-h7rwg, Status:200, Message: Liveness: false
</code></pre></li>
<li><p>Verify that backend pod return 504</p>
<pre><code class="lang-bash">oc exec -n project1 -c backend $(oc get pod -n project1 | grep -m1 backend | cut -d &quot; &quot; -f1) -- curl -sv http://localhost:8080/
</code></pre>
<p>Sample output</p>
<pre><code>*   Trying ::1...
* TCP_NODELAY set
* Connected to localhost (::1) port 8080 (#0)
&gt; GET / HTTP/1.1
&gt; Host: localhost:8080
&gt; User-Agent: curl/7.61.1
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 504 Gateway Timeout
&lt; Content-Encoding: text/plain
&lt; Expires: Tue, 02 Feb 2021 08:42:33 GMT
&lt; Content-Length: 124
&lt; Content-Type: text/plain;charset=UTF-8
&lt;
{ [124 bytes data]
* Connection #0 to host localhost left intact
Backend version:v1, Response:504, Host:backend-v1-f4dbf777f-h7rwg, Status:504, Message: Application liveness is set to false
</code></pre></li>
<li><p>Test again with cURL. You will get 504 just one times.</p>
<pre><code class="lang-bash">loop_frontend 15
</code></pre>
<p>Sample output</p>
<pre><code class="lang-bash">Host:backend-v1-f4dbf777f-h7rwg=&gt; Status:504
Host:backend-v1-f4dbf777f-vjhcl=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-vjhcl=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-vjhcl=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-vjhcl=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
Host:backend-v1-f4dbf777f-vjhcl=&gt; Status:200
Host:backend-v1-f4dbf777f-tgssd=&gt; Status:200
</code></pre>
</li>
<li><p>Check Kiali Console. Remark that there is lightning icon at backend service. This is represent for circuit breaker.</p>
<p><img src="images/kiali-graph-cb.gif" alt=""></p>
</li>
<li><p>Set backend pod to normal status</p>
<pre><code class="lang-bash">oc exec -n project1 -c backend $(oc get pod -n project1 | grep -m1 backend | cut -d &quot; &quot; -f1) -- curl -sv http://localhost:8080/start
</code></pre>
<h2 id="secure-with-mtls">Secure with mTLS</h2>
<p>Check following Git for setup mTLS between service and ingress service</p>
</li>
</ul>
<p><a href="https://github.com/voraviz/openshift-service-mesh-ingress-mtls" target="_blank">Secure Application with mTLS by OpenShift Service Mesh</a></p>
<h2 id="service-level-objective-slo">Service Level Objective (SLO)</h2>
<ul>
<li>We can use Service Level Indicator (SLI) and Service Level Objective (SLO) to determine and measure availability of services. For RESTful Web Service we can use HTTP response code to measure for SLI</li>
<li>Prometheus in Service Mesh&apos;s control plane contains information about HTTP responses then we can use following PromQL to check for the sucessfull request and total request of backend service<ul>
<li>Success Rate<ul>
<li>Successful request for last 5 minutes<pre><code>sum(increase(istio_requests_total{destination_service_name=&quot;backend&quot;,response_code!~&quot;5*&quot;}[5m]))
</code></pre><img src="images/prometheus-backend-service-total-request.png" alt=""></li>
<li>Total requests for last 5 minutes<pre><code>sum(increase(istio_requests_total{destination_service_name=&quot;backend&quot;}[5m]))
</code></pre></li>
<li>Sample data provided by Prometheus<pre><code>istio_requests_total{connection_security_policy=&quot;unknown&quot;,destination_app=&quot;backend&quot;,destination_canonical_revision=&quot;v1&quot;,destination_canonical_service=&quot;backend&quot;,destination_principal=&quot;spiffe://cluster.local/ns/user1/sa/default&quot;,destination_service=&quot;backend.user1.svc.cluster.local&quot;,destination_service_name=&quot;backend&quot;,destination_service_namespace=&quot;user1&quot;,destination_version=&quot;v1&quot;,destination_workload=&quot;backend-v1&quot;,destination_workload_namespace=&quot;user1&quot;,instance=&quot;10.128.2.42:15090&quot;,job=&quot;envoy-stats&quot;,namespace=&quot;user1&quot;,pod_name=&quot;frontend-v1-66fbd89459-8ksr8&quot;,reporter=&quot;source&quot;,request_protocol=&quot;http&quot;,response_code=&quot;503&quot;,response_flags=&quot;URX&quot;,source_app=&quot;frontend&quot;,source_canonical_revision=&quot;v1&quot;,source_canonical_service=&quot;frontend&quot;,source_principal=&quot;spiffe://cluster.local/ns/user1/sa/default&quot;,source_version=&quot;v1&quot;,source_workload=&quot;frontend-v1&quot;,source_workload_namespace=&quot;user1&quot;}
</code></pre></li>
</ul>
</li>
<li>Latency<ul>
<li>99th Percentile of response time in sec of frontend service<pre><code>histogram_quantile(0.99, sum(rate(istio_request_duration_milliseconds_bucket{destination_service_name=&quot;frontend&quot;,response_code!~&quot;5*&quot;}[5m])) by (le))/1000
</code></pre></li>
</ul>
</li>
</ul>
</li>
<li>SLO for success rate can be calculated by following PromQL and compare this to your desired service level e.g. 99.9%<pre><code>sum(increase(istio_requests_total{destination_service_name=&quot;backend&quot;,response_code!~&quot;5*&quot;}[5m])) / sum(increase(istio_requests_total{destination_service_name=&quot;backend&quot;}[5m]))*100
</code></pre></li>
<li><p>Configure Grafana Dashboard in OpenShift Service Mesh&apos;s control plane for measuring <a href="manifests/grafana-slo-dashboard.json">SLO Dashbaord</a></p>
<ul>
<li>Backend Application service %availability<pre><code>sum(increase(istio_requests_total{destination_service_name=&quot;backend&quot;,response_code!~&quot;5.*&quot;}[5m])) / sum(increase(istio_requests_total{destination_service_name=&quot;backend&quot;}[5m])) *100
</code></pre></li>
<li>Frontend 99th percentile response time in second<pre><code>histogram_quantile(0.99, sum(rate(istio_request_duration_milliseconds_bucket{destination_service_name=&quot;frontend&quot;,response_code!~&quot;5*&quot;}[5m])) by (le))/1000
</code></pre></li>
<li>Backend 99th percentile response time in second<pre><code>histogram_quantile(0.99, sum(rate(istio_request_duration_milliseconds_bucket{destination_service_name=&quot;backend&quot;,response_code!~&quot;5*&quot;}[5m])) by (le))/1000
</code></pre></li>
</ul>
<p><img src="images/grafana-dashboard-slo.png" alt="">
&lt;!-- </p>
</li>
</ul>
<p>--&gt;</p>
<h2 id="control-plane-with-high-availability">Control Plane with High Availability</h2>
<h3 id="openshift-service-mesh-1x">OpenShift Service Mesh 1.x</h3>
<p><a href="manifests/smcp-v1-ha.yaml">ServiceMeshControlPlane</a> with high availability configuration</p>
<ul>
<li><p>Configure Horizontal Pod Autoscaler (HPA) for ingress-gateway</p>
<ul>
<li>Set request and limit</li>
<li>Set autoscaling to true</li>
<li><p>Set number of min and max replicas with target CPU utilization to trigger HPA</p>
<pre><code class="lang-yaml">ingress:
  enabled: true
  runtime:
    container:
      resources:
        requests:
          cpu: 500m
          memory: 300Mi
        limits:
          cpu: 2
          memory: 1Gi
    deployment:
      autoScaling:
        enabled: true
        maxReplicas: 4
        minReplicas: 2
        targetCPUUtilizationPercentage: 85
</code></pre>
</li>
</ul>
</li>
<li><p>For others components </p>
<ul>
<li><p>Set number of replicas to 2</p>
<pre><code class="lang-yaml">    deployment:
      autoScaling:
        enabled: false
      replicas: 2
</code></pre>
</li>
<li><p>Set pod anti-affinity to prevent scheduler to place pods to the same node</p>
<p><em>Remark: namespaces in podAntiAffinity is needed to support multiples control planes in the same OpenShift cluster. Change this to match name of control plane&apos;s namespace</em> </p>
<pre><code class="lang-yaml">    pod:
      tolerations:
      - key: node.kubernetes.io/unreachable
        operator: Exists
        effect: NoExecute
        tolerationSeconds: 60
      affinity:
        podAntiAffinity:
          requiredDuringScheduling:
          - key: istio
            topologyKey: kubernetes.io/hostname
            operator: In
            values:
            - galley
            namespaces: istio-system
</code></pre>
</li>
</ul>
</li>
<li><p>Check that pods of each deployment run on different nodes</p>
<pre><code class="lang-bash">oc get pods -o wide -n istio-system -o custom-columns=NAME:.metadata.name,NODE:.spec.nodeName,PHASE:.status.phase
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">NAME                                    NODE                                        PHASE
grafana-7bdb4fb848-847c8                ip-10-0-160-48.us-east-2.compute.internal   Running
istio-citadel-6668b5b947-njgbb          ip-10-0-160-48.us-east-2.compute.internal   Running
istio-citadel-6668b5b947-nk9dz          ip-10-0-137-21.us-east-2.compute.internal   Running
istio-galley-6dc7f9c496-hkm57           ip-10-0-137-21.us-east-2.compute.internal   Running
istio-galley-6dc7f9c496-qcw9q           ip-10-0-160-48.us-east-2.compute.internal   Running
istio-ingressgateway-6bcd484457-25tq7   ip-10-0-137-21.us-east-2.compute.internal   Running
istio-ingressgateway-6bcd484457-nvfb9   ip-10-0-160-48.us-east-2.compute.internal   Running
istio-pilot-74d5db759c-m9jxm            ip-10-0-137-21.us-east-2.compute.internal   Running
istio-pilot-74d5db759c-rcdxj            ip-10-0-160-48.us-east-2.compute.internal   Running
istio-policy-58ff56d7dc-26wsq           ip-10-0-137-21.us-east-2.compute.internal   Running
istio-policy-58ff56d7dc-62gwl           ip-10-0-160-48.us-east-2.compute.internal   Running
istio-sidecar-injector-ffc58c87-4t5gc   ip-10-0-137-21.us-east-2.compute.internal   Running
istio-sidecar-injector-ffc58c87-rjz7l   ip-10-0-160-48.us-east-2.compute.internal   Running
istio-telemetry-646d7cf56c-fz72g        ip-10-0-137-21.us-east-2.compute.internal   Running
istio-telemetry-646d7cf56c-lctxg        ip-10-0-160-48.us-east-2.compute.internal   Running
jaeger-7b866d475f-nhrp5                 ip-10-0-160-48.us-east-2.compute.internal   Running
kiali-75dc58b5f6-bwk7q                  ip-10-0-137-21.us-east-2.compute.internal   Running
prometheus-85db9d786b-vzskf             ip-10-0-160-48.us-east-2.compute.internal   Running
prometheus-85db9d786b-wgrwz             ip-10-0-137-21.us-east-2.compute.internal   Running
</code></pre>
</li>
<li><p>Verify HPA for ingress gateway</p>
<pre><code class="lang-bash">oc get hpa -n istio-system
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">NAME                   REFERENCE                         TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
istio-ingressgateway   Deployment/istio-ingressgateway   0%/85%    2         4         2          10m
</code></pre>
</li>
</ul>
<h3 id="openshift-service-mesh-2x">OpenShift Service Mesh 2.x</h3>
<p><a href="manifests/smcp-ha.yaml">ServiceMeshControlPlane</a> with high availability configuration</p>
<ul>
<li><p>Configure Horizontal Pod Autoscaler (HPA) for ingress-gateway</p>
<ul>
<li>Set request and limit</li>
<li>Set autoscaling to true</li>
<li><p>Set number of min and max replicas with target CPU utilization to trigger HPA</p>
<pre><code class="lang-yaml">ingress:
  enabled: true
  runtime:
    container:
      resources:
        requests:
          cpu: 500m
          memory: 300Mi
        limits:
          cpu: 2
          memory: 1Gi
    deployment:
      autoScaling:
        enabled: true
        maxReplicas: 4
        minReplicas: 2
        targetCPUUtilizationPercentage: 85
</code></pre>
</li>
</ul>
</li>
<li><p>For others components </p>
<ul>
<li><p>Set number of replicas to 2</p>
<pre><code class="lang-yaml">pilot:
  deployment:
    replicas: 2
</code></pre>
</li>
</ul>
<!-- - Set Pod Disruption Budget (PDB) with minAvailable to 1

  ```yaml
  defaults:
    deployment:
      podDisruption:
        enabled: true
        minAvailable: 1
  ``` -->
</li>
<li><p>Check that pods of each deployment run on different nodes</p>
<pre><code class="lang-bash">oc get pods -n istio-system
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">grafana-78f656547-gkm92                 2/2     Running   0          54s
istio-ingressgateway-667749f4bd-pfl2l   1/1     Running   0          54s
istio-ingressgateway-667749f4bd-sfwx4   1/1     Running   0          39s
istiod-basic-install-6994d86579-4n8jf   1/1     Running   0          77s
istiod-basic-install-6994d86579-b5bgv   1/1     Running   0          77s
jaeger-85d4744d8b-krqfl                 2/2     Running   0          54s
kiali-784df775f8-xccsw                  1/1     Running   0          28s
prometheus-79ff59d59f-6j99k             3/3     Running   0          65s
prometheus-79ff59d59f-msrpb             3/3     Running   0          65s
</code></pre>
</li>
<li><p>Verify HPA for ingress gateway</p>
<pre><code class="lang-bash">oc get hpa -n istio-system
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">NAME                   REFERENCE                         TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
istio-ingressgateway   Deployment/istio-ingressgateway   0%/85%    2         4         2          10m
</code></pre>
</li>
<li><p>Check that pods of each deployment run on different nodes</p>
<pre><code class="lang-bash">oc get pods -o wide -n istio-system -o custom-columns=NAME:.metadata.name,NODE:.spec.nodeName,PHASE:.status.phase
</code></pre>
<p>Output</p>
<pre><code class="lang-bash">NAME                                    NODE                                         PHASE
grafana-5bcbbc7877-n4zzm                ip-10-0-152-186.us-east-2.compute.internal   Running
istio-ingressgateway-5fbfcc6d7f-8xfnk   ip-10-0-152-186.us-east-2.compute.internal   Running
istio-ingressgateway-5fbfcc6d7f-k2wrw   ip-10-0-162-66.us-east-2.compute.internal    Running
istiod-basic-install-66859cc44b-db6pw   ip-10-0-162-66.us-east-2.compute.internal    Running
istiod-basic-install-66859cc44b-wvnrj   ip-10-0-152-186.us-east-2.compute.internal   Running
jaeger-6d9cd754d8-wbsm9                 ip-10-0-152-186.us-east-2.compute.internal   Running
prometheus-7dc95494b-klmms              ip-10-0-152-186.us-east-2.compute.internal   Running
prometheus-7dc95494b-x8gvf              ip-10-0-162-66.us-east-2.compute.internal    Running
</code></pre>
</li>
</ul>
<!-- - Verify PDB for istiod

  ```bash
  oc describe pdb/istiod-basic-install
  ```

  Output

  ```bash
  Name:           istiod-basic-install
  Namespace:      istio-system
  Min available:  1
  Selector:       app=istiod,istio.io/rev=basic-install
  Status:
      Allowed disruptions:  1
      Current:              2
      Desired:              1
      Total:                2
  Events:
    Type    Reason  Age                    From               Message
    ----    ------  ----                   ----               -------
    Normal  NoPods  2m17s (x2 over 2m17s)  controllermanager  No matching pods found
  ``` -->
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="health.html" class="navigation navigation-prev " aria-label="Previous page: Health Check">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="application-metrics.html" class="navigation navigation-next " aria-label="Next page: User Workload Monitoring">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"OpenShift Service Mesh","level":"1.4.8","depth":2,"next":{"title":"User Workload Monitoring","level":"1.4.9","depth":2,"path":"application-metrics.md","ref":"application-metrics.md","articles":[]},"previous":{"title":"Health Check","level":"1.4.7","depth":2,"path":"health.md","ref":"health.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-lunr","-search","-highlight","-livereload","search-plus","copy-code-button","mermaid-gb3"],"root":"./","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"mermaid-newface":{"theme":"neutral"},"search-plus":{},"copy-code-button":{},"mermaid-gb3":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Red Hat Thailand SA","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"OpenShift Demo","gitbook":"3.2.3"},"file":{"path":"openshift-service-mesh.md","mtime":"2021-06-24T15:50:21.511Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-06-24T15:51:11.203Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    <script src="gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>

    </body>
</html>

