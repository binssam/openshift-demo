
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>OpenShift Authentication Providers with AD Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="infrastructure-infra-nodes.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Infrastructure
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.2.1" data-path="infrastructure-authentication-providers.html">
            
                <a href="infrastructure-authentication-providers.html">
            
                    
                    OpenShift Authentication Providers with AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="infrastructure-infra-nodes.html">
            
                <a href="infrastructure-infra-nodes.html">
            
                    
                    OpenShift MachineSet and Infrastructure Nodes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="infrastructure-monitoring-alerts.html">
            
                <a href="infrastructure-monitoring-alerts.html">
            
                    
                    OpenShift Platform Monitoring and Alert
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="infrastructure-cluster-logging.html">
            
                <a href="infrastructure-cluster-logging.html">
            
                    
                    OpenShift Cluster Logging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="infrastructure-networking.html">
            
                <a href="infrastructure-networking.html">
            
                    
                    OpenShift Networking
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="infrastructure-backup-etcd.html">
            
                <a href="infrastructure-backup-etcd.html">
            
                    
                    OpenShift state backup with etcd snapshot
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Container Applications
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="helm.html">
            
                <a href="helm.html">
            
                    
                    Application Deployment with Helm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="openshift-route.html">
            
                <a href="openshift-route.html">
            
                    
                    OpenShift Route
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="hpa.html">
            
                <a href="hpa.html">
            
                    
                    Horizontal Pod Autoscaler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="health.html">
            
                <a href="health.html">
            
                    
                    Health Check
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="openshift-service-mesh.html">
            
                <a href="openshift-service-mesh.html">
            
                    
                    OpenShift Service Mesh
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="application-metrics.html">
            
                <a href="application-metrics.html">
            
                    
                    User Workload Monitoring
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="ci-cd.html">
            
                <a href="ci-cd.html">
            
                    
                    CI/CD with Azure DevOps
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >OpenShift Authentication Providers with AD</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="authentication-providers-with-ad">Authentication Providers with AD</h1>
<!-- TOC -->
<ul>
<li><a href="#authentication-providers-with-ad">Authentication Providers with AD</a><ul>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#openshift-rbac-with-ad">OpenShift RBAC with AD</a><ul>
<li><a href="#background-ldap-structure">Background: LDAP Structure</a><ul>
<li><a href="#examine-the-oauth-configuration">Examine the OAuth configuration</a></li>
<li><a href="#syncing-ldap-groups-to-openshift-groups">Syncing LDAP Groups to OpenShift Groups</a></li>
<li><a href="#change-group-policy">Change Group Policy</a></li>
<li><a href="#examine-cluster-admin-policy">Examine <code>cluster-admin</code> policy</a></li>
<li><a href="#examine-cluster-reader-policy">Examine <code>cluster-reader</code> policy</a></li>
<li><a href="#create-projects-for-collaboration">Create Projects for Collaboration</a></li>
<li><a href="#map-groups-to-projects">Map Groups to Projects</a></li>
<li><a href="#examine-group-access">Examine Group Access</a></li>
<li><a href="#prometheus">Prometheus</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>Microsoft AD (with LDAP protocol)</li>
<li>Users and Groups</li>
<li>Assigned Roles</li>
</ul>
<h2 id="openshift-rbac-with-ad">OpenShift RBAC with AD</h2>
<p>Configuring External Authentication Providers</p>
<p>OpenShift supports a number of different authentication providers, and you can
find the complete list in the <a href="https://docs.openshift.com/container-platform/4.6/authentication/understanding-identity-provider.html" target="_blank">understanding identity provider configuration</a>. One of the most commonly used authentication
providers is LDAP, whether provided by Microsoft Active Directory or by other
sources.</p>
<p>OpenShift can perform user authentication against an LDAP server, and can also
configure group membership and certain RBAC attributes based on LDAP group
membership.</p>
<h3 id="background-ldap-structure">Background: LDAP Structure</h3>
<p>In this environment we are providing LDAP with the following user groups:</p>
<ul>
<li><code>ocp-user</code>: Users with OpenShift access<ul>
<li>Any users who should be able to log-in to OpenShift must be members of this
group</li>
<li>All of the below mentioned users are in this group</li>
</ul>
</li>
<li><code>ocp-normal-dev</code>: Normal OpenShift users<ul>
<li>Regular users of OpenShift without special permissions</li>
<li>Contains: <code>normaluser1</code>, <code>teamuser1</code>, <code>teamuser2</code></li>
</ul>
</li>
<li><code>ocp-fancy-dev</code>: Fancy OpenShift users<ul>
<li>Users of OpenShift that are granted some special privileges</li>
<li>Contains: <code>fancyuser1</code>, <code>fancyuser2</code></li>
</ul>
</li>
<li><code>ocp-teamed-app</code>: Teamed app users<ul>
<li>A group of users that will have access to the same OpenShift <em>Project</em></li>
<li>Contains: <code>teamuser1</code>, <code>teamuser2</code></li>
</ul>
</li>
</ul>
<h4 id="examine-the-oauth-configuration">Examine the OAuth configuration</h4>
<p>Since this is a pure, vanilla OpenShift 4 installation, it has the default OAuth resource. You can examine that OAuth configuration with the following:</p>
<pre><code class="lang-bash">oc get oauth cluster -o yaml
</code></pre>
<p>You will see something like:</p>
<pre><code class="lang-YAML"><span class="hljs-attr">apiVersion:</span> config.openshift.io/v1
<span class="hljs-attr">kind:</span> OAuth
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  annotations:</span>
    release.openshift.io/create-only: <span class="hljs-string">&quot;true&quot;</span>
<span class="hljs-attr">  creationTimestamp:</span> <span class="hljs-string">&quot;2020-03-17T18:12:52Z&quot;</span>
<span class="hljs-attr">  generation:</span> <span class="hljs-number">1</span>
<span class="hljs-attr">  name:</span> cluster
<span class="hljs-attr">  resourceVersion:</span> <span class="hljs-string">&quot;1563&quot;</span>
<span class="hljs-attr">  selfLink:</span> /apis/config.openshift.io/v1/oauths/cluster
<span class="hljs-attr">  uid:</span> ebb0582d-b0e4<span class="hljs-bullet">-4</span>c40-a33f<span class="hljs-bullet">-12459593</span>f8e2
<span class="hljs-attr">spec:</span> {}
</code></pre>
<p>There are a few things to note here. Firstly, there&apos;s basically nothing here!
How does the <code>kubeadmin</code> user work, then? The OpenShift OAuth system knows to
look for a <code>kubeadmin</code> <em>Secret</em> in the <code>kube-system</code> <em>Namespace</em>. You can
examine it with the following:</p>
<pre><code class="lang-bash">oc get secret -n kube-system kubeadmin -o yaml
</code></pre>
<p>You will see something like:</p>
<pre><code class="lang-YAML"><span class="hljs-attr">apiVersion:</span> v1
<span class="hljs-attr">data:</span>
<span class="hljs-attr">  kubeadmin:</span> JDJhJDEwJDdQNHZtbXMxdmpDa3FsNlJMLjJBcC5BSWdBazB6d09IWUdXZEdrRXBERGRwWXNmVVcxanpX
<span class="hljs-attr">kind:</span> Secret
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  creationTimestamp:</span> <span class="hljs-string">&quot;2019-04-29T17:30:51Z&quot;</span>
<span class="hljs-attr">  name:</span> kubeadmin
<span class="hljs-attr">  namespace:</span> kube-system
<span class="hljs-attr">  resourceVersion:</span> <span class="hljs-string">&quot;2065&quot;</span>
<span class="hljs-attr">  selfLink:</span> /api/v1/namespaces/kube-system/secrets/kubeadmin
<span class="hljs-attr">  uid:</span> <span class="hljs-number">892945</span>dc<span class="hljs-bullet">-6</span>aa4<span class="hljs-bullet">-11e9</span><span class="hljs-bullet">-9959</span><span class="hljs-bullet">-02774</span>c6d6b2e
<span class="hljs-attr">type:</span> Opaque
</code></pre>
<p>That <em>Secret</em> contains the encoded hash of the <code>kubeadmin</code> password. This
account will continue to work even after we configure a new <code>OAuth</code>. If you
want to disable it, you would need to delete the secret.</p>
<p>In a real-world environment, you will likely want to integrate with your
existing identity management solution. For this lab we are configuring LDAP
as our <code>identityProvider</code>. Here&apos;s an example of the OAuth configuration. Look
for the element in <code>identityProviders</code> with <code>type: LDAP</code> like the following:</p>
<pre><code class="lang-bash">apiVersion: config.openshift.io/v1
kind: OAuth
metadata:
  name: cluster
spec:
  identityProviders:
  - name: ldap
    challenge: <span class="hljs-literal">false</span>
    login: <span class="hljs-literal">true</span>
    mappingMethod: claim
    <span class="hljs-built_in">type</span>: LDAP
    ldap:
      attributes:
        id:
        - distinguishedName
        email:
        - userPrincipalName
        name:
        - givenName
        preferredUsername:
        - sAMAccountName
      <span class="hljs-built_in">bind</span>DN: <span class="hljs-string">&quot;cn=ldapuser,cn=Users,dc=dcloud,dc=demo,dc=com&quot;</span>
      <span class="hljs-built_in">bind</span>Password:
        name: ldapuser-secret
      insecure: <span class="hljs-literal">true</span>
      url: <span class="hljs-string">&quot;ldap://ad1.dcloud.demo.com:389/cn=Users,dc=dcloud,dc=demo,dc=com?sAMAccountName?sub?(memberOf=cn=ocp-user,cn=Users,dc=dcloud,dc=demo,dc=com)&quot;</span>
  tokenConfig:
    accessTokenMaxAgeSeconds: 86400
</code></pre>
<p>Some notable fields under <code>identityProviders:</code>:</p>
<ol>
<li><p><code>name</code>: The unique ID of the identity provider. It is possible to have
multiple authentication providers in an OpenShift environment, and OpenShift is
able to distinguish between them.</p>
</li>
<li><p><code>mappingMethod: claim</code>: This section has to do with how usernames are
assigned within an OpenShift cluster when multiple providers are configured. See
the <a href="https://docs.openshift.com/container-platform/4.6/authentication/understanding-identity-provider.html#identity-provider-parameters-understanding-identity-provider" target="_blank">Identity provider parameters</a> section for more information.</p>
</li>
<li><p><code>attributes</code>: This section defines the LDAP fields to iterate over and
assign to the fields in the OpenShift user&apos;s &quot;account&quot;. If any attributes are
not found / not populated when searching through the list, the entire
authentication fails. In this case we are creating an identity that is
associated with the AD <code>distinguishedName</code>, an email address from the LDAP <code>userPrincipalName</code>, a name from
the LDAP <code>givenName</code>, and a username from the AD <code>sAMAccountName</code>.</p>
</li>
<li><p><code>bindDN</code>: When searching LDAP, bind to the server as this user.</p>
</li>
<li><p><code>bindPassword</code>: Reference to the Secret that has the password to use when binding for searching.</p>
</li>
<li><p><code>url</code>: Identifies the LDAP server and the search to perform.</p>
</li>
</ol>
<p>For more information on the specific details of LDAP authentication in
OpenShift you can refer to the
<a href="https://docs.openshift.com/container-platform/4.6/authentication/identity_providers/configuring-ldap-identity-provider.html" target="_blank">Configuring an LDAP identity provider</a> documentation.</p>
<p>To setup the LDAP identity provider we must:</p>
<ol>
<li>Create a <code>Secret</code> with the bind password.</li>
<li>Update the <code>cluster</code> <code>OAuth</code> object with the LDAP identity provider.</li>
</ol>
<p>As the <code>kubeadmin</code> user apply the OAuth configuration with <code>oc</code>.</p>
<pre><code class="lang-yaml">oc create secret generic ldapuser-secret --from-literal=bindPassword=b1ndP^ssword -n openshift-config

cat &lt;&lt;EOF | oc apply -f -
<span class="hljs-attr">apiVersion:</span> config.openshift.io/v1
<span class="hljs-attr">kind:</span> OAuth
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> cluster
<span class="hljs-attr">spec:</span>
<span class="hljs-attr">  identityProviders:</span>
<span class="hljs-attr">  - name:</span> ldap
<span class="hljs-attr">    challenge:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">    login:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">    mappingMethod:</span> claim
<span class="hljs-attr">    type:</span> LDAP
<span class="hljs-attr">    ldap:</span>
<span class="hljs-attr">      attributes:</span>
<span class="hljs-attr">        id:</span>
<span class="hljs-bullet">        -</span> distinguishedName
<span class="hljs-attr">        email:</span>
<span class="hljs-bullet">        -</span> userPrincipalName
<span class="hljs-attr">        name:</span>
<span class="hljs-bullet">        -</span> givenName
<span class="hljs-attr">        preferredUsername:</span>
<span class="hljs-bullet">        -</span> sAMAccountName
<span class="hljs-attr">      bindDN:</span> <span class="hljs-string">&quot;cn=ldapuser,cn=Users,dc=dcloud,dc=demo,dc=com&quot;</span>
<span class="hljs-attr">      bindPassword:</span>
<span class="hljs-attr">        name:</span> ldapuser-secret
<span class="hljs-attr">      insecure:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">      url:</span> <span class="hljs-string">&quot;ldap://ad1.dcloud.demo.com:389/cn=Users,dc=dcloud,dc=demo,dc=com?sAMAccountName?sub?(memberOf=cn=ocp-user,cn=Users,dc=dcloud,dc=demo,dc=com)&quot;</span>
<span class="hljs-attr">  tokenConfig:</span>
<span class="hljs-attr">    accessTokenMaxAgeSeconds:</span> <span class="hljs-number">86400</span>
EOF
</code></pre>
<h4 id="syncing-ldap-groups-to-openshift-groups">Syncing LDAP Groups to OpenShift Groups</h4>
<p>In OpenShift, groups can be used to manage users and control permissions for
multiple users at once. There is a section in the documentation on how to
<a href="https://docs.openshift.com/container-platform/3.11/install_config/syncing_groups_with_ldap.html" target="_blank">sync groups with LDAP</a>. Syncing groups involves running a program called <code>groupsync</code>
when logged into OpenShift as a user with <code>cluster-admin</code> privileges, and using
a configuration file that tells OpenShift what to do with the users it finds in
the various groups.</p>
<p>We have provided a <code>groupsync</code> configuration file for you:</p>
<p>View configuration file</p>
<pre><code class="lang-yaml"><span class="hljs-attr">kind:</span> LDAPSyncConfig
<span class="hljs-attr">apiVersion:</span> v1
<span class="hljs-attr">url:</span> ldap://ad1.dcloud.demo.com:<span class="hljs-number">389</span>
<span class="hljs-attr">insecure:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">bindDN:</span> cn=ldapuser,cn=Users,dc=dcloud,dc=demo,dc=com
<span class="hljs-attr">bindPassword:</span> b1ndP^ssword
<span class="hljs-attr">rfc2307:</span>
<span class="hljs-attr">  groupsQuery:</span>
<span class="hljs-attr">    baseDN:</span> cn=Users,dc=dcloud,dc=demo,dc=com
<span class="hljs-attr">    derefAliases:</span> never
<span class="hljs-attr">    filter:</span> (cn=ocp-*)
<span class="hljs-attr">    scope:</span> sub
<span class="hljs-attr">    pageSize:</span> <span class="hljs-number">0</span>
<span class="hljs-attr">  groupUIDAttribute:</span> distinguishedName
<span class="hljs-attr">  groupNameAttributes:</span>
<span class="hljs-bullet">  -</span> cn
<span class="hljs-attr">  groupMembershipAttributes:</span>
<span class="hljs-bullet">  -</span> member
<span class="hljs-attr">  usersQuery:</span>
<span class="hljs-attr">    baseDN:</span> cn=Users,dc=dcloud,dc=demo,dc=com
<span class="hljs-attr">    derefAliases:</span> never
<span class="hljs-attr">    filter:</span> (objectclass=user)
<span class="hljs-attr">    scope:</span> sub
<span class="hljs-attr">    pageSize:</span> <span class="hljs-number">0</span>
<span class="hljs-attr">  userUIDAttribute:</span> distinguishedName
<span class="hljs-attr">  userNameAttributes:</span>
<span class="hljs-bullet">  -</span> sAMAccountName
</code></pre>
<p>Without going into too much detail (you can look at the documentation), the
<code>groupsync</code> config file does the following:</p>
<ul>
<li>searches LDAP using the specified bind user and password</li>
<li>queries for any LDAP groups whocp name begins with <code>ocp-</code></li>
<li>creates OpenShift groups with a name from the <code>cn</code> of the LDAP group</li>
<li>finds the members of the LDAP group and then puts them into the created
OpenShift group</li>
<li>uses the <code>dn</code> and <code>uid</code> as the UID and name attributes, respectively, in
OpenShift</li>
</ul>
<p>Execute the <code>groupsync</code>:</p>
<pre><code class="lang-yaml">cat &lt;&lt;EOF &gt; groupsync.yaml
<span class="hljs-attr">kind:</span> LDAPSyncConfig
<span class="hljs-attr">apiVersion:</span> v1
<span class="hljs-attr">url:</span> ldap://ad1.dcloud.demo.com:<span class="hljs-number">389</span>
<span class="hljs-attr">insecure:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">bindDN:</span> cn=ldapuser,cn=Users,dc=dcloud,dc=demo,dc=com
<span class="hljs-attr">bindPassword:</span> b1ndP^ssword
<span class="hljs-attr">rfc2307:</span>
<span class="hljs-attr">  groupsQuery:</span>
<span class="hljs-attr">    baseDN:</span> cn=Users,dc=dcloud,dc=demo,dc=com
<span class="hljs-attr">    derefAliases:</span> never
<span class="hljs-attr">    filter:</span> (cn=ocp-*)
<span class="hljs-attr">    scope:</span> sub
<span class="hljs-attr">    pageSize:</span> <span class="hljs-number">0</span>
<span class="hljs-attr">  groupUIDAttribute:</span> distinguishedName
<span class="hljs-attr">  groupNameAttributes:</span>
<span class="hljs-bullet">  -</span> cn
<span class="hljs-attr">  groupMembershipAttributes:</span>
<span class="hljs-bullet">  -</span> member
<span class="hljs-attr">  usersQuery:</span>
<span class="hljs-attr">    baseDN:</span> cn=Users,dc=dcloud,dc=demo,dc=com
<span class="hljs-attr">    derefAliases:</span> never
<span class="hljs-attr">    filter:</span> (objectclass=user)
<span class="hljs-attr">    scope:</span> sub
<span class="hljs-attr">    pageSize:</span> <span class="hljs-number">0</span>
<span class="hljs-attr">  userUIDAttribute:</span> distinguishedName
<span class="hljs-attr">  userNameAttributes:</span>
<span class="hljs-bullet">  -</span> sAMAccountName
EOF
oc adm groups sync --sync-config=./groupsync.yaml --confirm
</code></pre>
<p>You will see output like the following:</p>
<pre><code class="lang-bash">group/ocp-fancy-dev
group/ocp-user
group/ocp-normal-dev
group/ocp-teamed-app
</code></pre>
<p>What you are seeing is the <em>Group</em> objects that have been created by the
<code>groupsync</code> command. If you are curious about the <code>--confirm</code> flag, check the
output of the help with <code>oc adm groups sync -h</code>.</p>
<p>If you want to see the <em>Groups</em> that were created, execute the following:</p>
<pre><code class="lang-bash">oc get groups
</code></pre>
<p>You will see output like the following:</p>
<pre><code class="lang-bash">NAME             USERS
ocp-admin        ldapuser
ocp-fancy-dev    fancyuser1, fancyuser2
ocp-normal-dev   normaluser1, teamuser1, teamuser2
ocp-teamed-app   teamuser1, teamuser2
ocp-user         fancyuser1, fancyuser2, normaluser1, teamuser1, teamuser2
</code></pre>
<p>Take a look at a specific group in YAML:</p>
<pre><code class="lang-bash">oc get group ocp-fancy-dev -o yaml
</code></pre>
<p>The YAML looks like:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> user.openshift.io/v1
<span class="hljs-attr">kind:</span> Group
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  annotations:</span>
    openshift.io/ldap.sync-time: <span class="hljs-number">2020</span><span class="hljs-bullet">-03</span><span class="hljs-bullet">-11</span>T10:<span class="hljs-number">57</span>:<span class="hljs-number">03</span><span class="hljs-bullet">-0400</span>
    openshift.io/ldap.uid: cn=ocp-fancy-dev,ou=Users,o=<span class="hljs-number">5e615</span>ba46b812e7da02e93b5,dc=jumpcloud,dc=com
    openshift.io/ldap.url: ldap.jumpcloud.com:<span class="hljs-number">636</span>
<span class="hljs-attr">  creationTimestamp:</span> <span class="hljs-string">&quot;2020-03-11T14:57:03Z&quot;</span>
<span class="hljs-attr">  labels:</span>
    openshift.io/ldap.host: ldap.jumpcloud.com
<span class="hljs-attr">  name:</span> ocp-fancy-dev
<span class="hljs-attr">  resourceVersion:</span> <span class="hljs-string">&quot;48481&quot;</span>
<span class="hljs-attr">  selfLink:</span> /apis/user.openshift.io/v1/groups/ocp-fancy-dev
<span class="hljs-attr">  uid:</span> <span class="hljs-number">630</span>a9d2b-b577<span class="hljs-bullet">-46</span>bd<span class="hljs-bullet">-8294</span><span class="hljs-bullet">-6</span>b26e7f9a6e1
<span class="hljs-attr">users:</span>
<span class="hljs-bullet">-</span> fancyuser1
<span class="hljs-bullet">-</span> fancyuser2
</code></pre>
<p>OpenShift has automatically associated some LDAP metadata with the <em>Group</em>, and
has listed the users who are in the group.</p>
<p>What happens if you list the <em>Users</em>?</p>
<pre><code class="lang-bash">oc get user
</code></pre>
<p>You will get:</p>
<pre><code class="lang-bash">No resources found.
</code></pre>
<p>Why would there be no <em>Users</em> found? They are clearly listed in the <em>Group</em>
definition.</p>
<p><em>Users</em> are not actually created until the first time they try to log in. What
you are seeing in the <em>Group</em> definition is simply a placeholder telling
OpenShift that, if it encounters a <em>User</em> with that specific ID, that it should
be associated with the <em>Group</em>.</p>
<h4 id="change-group-policy">Change Group Policy</h4>
<p>We will grant a cluster role <code>cluster-admin</code> to ldap group <code>ocp-admin</code></p>
<p>Change the policy for the <code>ocp-admin</code> <em>Group</em>:</p>
<pre><code class="lang-bash">oc adm policy add-cluster-role-to-group cluster-admin ocp-admin
</code></pre>
<p>In your environment, there is a special group of super developers called
<em>ocp-fancy-dev</em> who should have special <code>cluster-reader</code> privileges. This is a role
that allows a user to view administrative-level information about the cluster.
For example, they can see the list of all <em>Projects</em> in the cluster.</p>
<p>Change the policy for the <code>ocp-fancy-dev</code> <em>Group</em>:</p>
<pre><code class="lang-bash">oc adm policy add-cluster-role-to-group cluster-reader ocp-fancy-dev
</code></pre>
<p><strong>Note:</strong> If you are interested in the different roles that come with OpenShift, you can
learn more about them in the
<a href="https://docs.openshift.com/container-platform/4.6/authentication/using-rbac.html" target="_blank">role-based access control (RBAC)</a> documentation.</p>
<h4 id="examine-cluster-admin-policy">Examine <code>cluster-admin</code> policy</h4>
<p>login as a <code>ldapuser</code></p>
<pre><code class="lang-bash">oc login -u ldapuser -p b1ndP^ssword
</code></pre>
<p>Then, try to list <em>Projects</em>:</p>
<pre><code class="lang-bash">oc get projects
</code></pre>
<p>You will see a full list of projects.</p>
<h4 id="examine-cluster-reader-policy">Examine <code>cluster-reader</code> policy</h4>
<p>Go ahead and login as a regular user:</p>
<pre><code class="lang-bash">oc login -u normaluser1 -p openshift
</code></pre>
<p>Then, try to list <em>Projects</em>:</p>
<pre><code class="lang-bash">oc get projects
</code></pre>
<p>You will see:</p>
<pre><code class="lang-bash">No resources found.
</code></pre>
<p>Now, login as a member of <code>ocp-fancy-dev</code>:</p>
<pre><code class="lang-bash">oc login -u fancyuser1 -p openshift
</code></pre>
<p>And then perform the same <code>oc get projects</code> and you will now see the list of all
of the projects in the cluster:</p>
<pre><code class="lang-bash">NAME                                                    DISPLAY NAME                        STATUS
    app-management
  * default
    kube-public
    kube-system
    labguide
    openshift
    openshift-apiserver
...
</code></pre>
<p>You should now be starting to understand how RBAC in OpenShift Container
Platform can work.</p>
<h4 id="create-projects-for-collaboration">Create Projects for Collaboration</h4>
<p>Make sure you login as the cluster administrator:</p>
<pre><code class="lang-bash">oc login -u ldapuser
</code></pre>
<p>Then, create several <em>Projects</em> for people to collaborate:</p>
<pre><code class="lang-bash">oc adm new-project app-dev --display-name=<span class="hljs-string">&quot;Application Development&quot;</span>
oc adm new-project app-test --display-name=<span class="hljs-string">&quot;Application Testing&quot;</span>
oc adm new-project app-prod --display-name=<span class="hljs-string">&quot;Application Production&quot;</span>
</code></pre>
<p>You have now created several <em>Projects</em> that represent a typical Software
Development Lifecycle setup. Next, you will configure <em>Groups</em> to grant
collaborative access to these projects.</p>
<p><strong>Note:</strong> Creating projects with <code>oc adm new-project</code> does <em>not</em> use the project request
process or the project request template. These projects will not have quotas or
limitranges applied by default. A cluster administrator can &quot;impersonate&quot; other
users, so there are several options if you wanted these projects to get
quotas/limit ranges:</p>
<p>. use <code>--as</code> to specify impersonating a regular user with <code>oc new-project</code>
. use <code>oc process</code> and provide values for the project request template, piping
  into create (eg: <code>oc process ... | oc create -f -</code>). This will create all of
  the objects in the project request template, which would include the quota and
  limit range.
. manually create/define the quota and limit ranges after creating the projects.</p>
<p>For these exercises it is not important to have quotas or limit ranges on these
projects.</p>
<h4 id="map-groups-to-projects">Map Groups to Projects</h4>
<p>As you saw earlier, there are several roles within OpenShift that are
preconfigured. When it comes to <em>Projects</em>, you similarly can grant view, edit,
or administrative access. Let&apos;s give our <code>ocp-teamed-app</code> users access to edit the
development and testing projects:</p>
<pre><code class="lang-bash">oc adm policy add-role-to-group edit ocp-teamed-app -n app-dev
oc adm policy add-role-to-group edit ocp-teamed-app -n app-test
</code></pre>
<p>And then give them access to view production:</p>
<pre><code class="lang-bash">oc adm policy add-role-to-group view ocp-teamed-app -n app-prod
</code></pre>
<p>Now, give the <code>ocp-fancy-dev</code> group edit access to the production project:</p>
<pre><code class="lang-bash">oc adm policy add-role-to-group edit ocp-fancy-dev -n app-prod
</code></pre>
<h4 id="examine-group-access">Examine Group Access</h4>
<p>Log in as <code>normaluser1</code> and see what <em>Projects</em> you can see:</p>
<pre><code class="lang-bash">oc login -u normaluser1 -p openshift
oc get projects
</code></pre>
<p>You should get:</p>
<pre><code class="lang-bash">No resources found.
</code></pre>
<p>Then, try <code>teamuser1</code> from the <code>ocp-teamed-app</code> group:</p>
<pre><code class="lang-bash">oc login -u teamuser1 -p openshift
oc get projects
</code></pre>
<p>You should get:</p>
<pre><code class="lang-bash">NAME       DISPLAY NAME              STATUS
app-dev    Application Development   Active
app-prod   Application Production    Active
app-test   Application Testing       Active
</code></pre>
<p>You did not grant the team users edit access to the production project. Go ahead
and try to create something in the production project as <code>teamuser1</code>:</p>
<pre><code class="lang-bash">oc project app-prod
oc new-app docker.io/siamaksade/mapit
</code></pre>
<p>You will see that it will not work:</p>
<pre><code class="lang-bash">error: can<span class="hljs-string">&apos;t lookup images: imagestreamimports.image.openshift.io is forbidden: User &quot;teamuser1&quot; cannot create resource &quot;imagestreamimports&quot; in API group &quot;image.openshift.io&quot; in the namespace &quot;app-prod&quot;
error:  local file access failed with: stat docker.io/siamaksade/mapit: no such file or directory
error: unable to locate any images in image streams, templates loaded in accessible projects, template files, local docker images with name &quot;docker.io/siamaksade/mapit&quot;

Argument &apos;</span>docker.io/siamaksade/mapit<span class="hljs-string">&apos; was classified as an image, image~source, or loaded template reference.

The &apos;</span>oc new-app<span class="hljs-string">&apos; command will match arguments to the following types:

  1. Images tagged into image streams in the current project or the &apos;</span>openshift<span class="hljs-string">&apos; project
     - if you don&apos;</span>t specify a tag, we<span class="hljs-string">&apos;ll add &apos;</span>:latest<span class="hljs-string">&apos;
  2. Images in the Docker Hub, on remote registries, or on the local Docker engine
  3. Templates in the current project or the &apos;</span>openshift<span class="hljs-string">&apos; project
  4. Git repository URLs or local paths that point to Git repositories

--allow-missing-images can be used to point to an image that does not exist yet.

See &apos;</span>oc new-app -h<span class="hljs-string">&apos; for examples.
</span></code></pre>
<p>This failure is exactly what we wanted to see.</p>
<h4 id="prometheus">Prometheus</h4>
<p>Now that you have a user with <code>cluster-reader</code> privileges (one that can see
many administrative aspects of the cluster), we can revisit Prometheus and
attempt to log-in to it.</p>
<p>Login as a the user with <code>cluster-reader</code> privileges:</p>
<pre><code class="lang-bash">oc login -u fancyuser1 -p openshift
</code></pre>
<p>Find the <code>prometheus</code> <code>Route</code> with the following command:</p>
<pre><code class="lang-bash">oc get route prometheus-k8s -n openshift-monitoring
</code></pre>
<p>You will see something like the following:</p>
<pre><code class="lang-bash">NAME             HOST/PORT                                                                      PATH   SERVICES         PORT   TERMINATION          WILDCARD
prometheus-k8s   prometheus-k8s-openshift-monitoring.{{ ROUTE_SUBDOMAIN }}          prometheus-k8s   web    reencrypt/Redirect   None
</code></pre>
<p><strong>Warning:</strong> Before continuing, make sure to go to the OpenShift web console and log out
by using the dropdown menu at the upper right where it says <code>kube:admin</code>.
Otherwise Prometheus will try to use your <code>kubeadmin</code> user to pass through
authentication. While it will work, it doesn&apos;t demonstrate the
<code>cluster-reader</code> role.</p>
<p>The installer configured a <code>Route</code> for Prometheus by default. Go ahead and
control+click the <a href="https://prometheus-k8s-openshift-monitoring.apps.ocp01.example.com" target="_blank">Prometheus link</a> to open it in your browser. You&apos;ll be
greeted with a login screen. Click the <em>Log in with OpenShift</em> button, then
select the <code>ldap</code> auth mechanism, and use the <code>fancyuser1</code> user that you gave
<code>cluster-reader</code> privileges to earlier. More specifically, the
<code>ocp-fancy-dev</code> group has <code>cluster-reader</code> permissions, and <code>fancyuser1</code> is a
member. Remember that the password for all of these users is <code>openshift</code>. You
will probably get a certificate error because of the self-signed certificate.
Make sure to accept it.</p>
<p>After logging in, the first time you will be presented with an auth proxy
permissions acknowledgement.</p>
<p>There is actually an OAuth proxy that sits in the flow between you and the
Prometheus container. This proxy is used to validate your AuthenticatioN
(AuthN) as well as authorize (AuthZ) what is allowed to happen. Here you are
explicitly authorizing the permissions from your <code>fancyuser1</code> account to be
used as part of accessing Prometheus. Hit <em>Allow selected permissions</em>.</p>
<p>At this point you are viewing Prometheus. There are no alerts configured. If
you look at <code>Status</code> and then <code>Targets</code> you can see some interesting
information about the current state of the cluster.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="infrastructure-infra-nodes.html" class="navigation navigation-next navigation-unique" aria-label="Next page: OpenShift MachineSet and Infrastructure Nodes">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"OpenShift Authentication Providers with AD","level":"1.2.1","depth":2,"next":{"title":"OpenShift MachineSet and Infrastructure Nodes","level":"1.2.2","depth":2,"path":"infrastructure-infra-nodes.md","ref":"infrastructure-infra-nodes.md","articles":[]},"previous":{"title":"Infrastructure","level":"1.2","depth":1,"ref":"","articles":[{"title":"OpenShift Authentication Providers with AD","level":"1.2.1","depth":2,"path":"infrastructure-authentication-providers.md","ref":"infrastructure-authentication-providers.md","articles":[]},{"title":"OpenShift MachineSet and Infrastructure Nodes","level":"1.2.2","depth":2,"path":"infrastructure-infra-nodes.md","ref":"infrastructure-infra-nodes.md","articles":[]},{"title":"OpenShift Platform Monitoring and Alert","level":"1.2.3","depth":2,"path":"infrastructure-monitoring-alerts.md","ref":"infrastructure-monitoring-alerts.md","articles":[]},{"title":"OpenShift Cluster Logging","level":"1.2.4","depth":2,"path":"infrastructure-cluster-logging.md","ref":"infrastructure-cluster-logging.md","articles":[]},{"title":"OpenShift Networking","level":"1.2.5","depth":2,"path":"infrastructure-networking.md","ref":"infrastructure-networking.md","articles":[]},{"title":"OpenShift state backup with etcd snapshot","level":"1.2.6","depth":2,"path":"infrastructure-backup-etcd.md","ref":"infrastructure-backup-etcd.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"infrastructure-authentication-providers.md","mtime":"2021-03-30T09:13:52.439Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-03-30T09:14:32.871Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

